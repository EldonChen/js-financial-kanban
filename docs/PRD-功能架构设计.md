# PRD - 功能架构设计

> **文档版本**：v1.0  
> **创建时间**：2025-01-06  
> **适用项目**：js-financial-kanban

## 1. 功能架构概览

### 1.1 架构层级

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Frontend)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │Dashboard │  │  Stocks  │  │  Items   │  │ Settings │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          ↓ HTTP
┌─────────────────────────────────────────────────────────┐
│                    BFF 层 (Backend For Frontend)          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │Dashboard │  │  Stocks  │  │  Items   │              │
│  │  View    │  │  View    │  │  View    │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
                          ↓ HTTP
┌─────────────────────────────────────────────────────────┐
│                   后台服务层 (Backend Services)           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  Python  │  │   Node    │  │   Rust   │  │  Stock   │ │
│  │ Service  │  │  Service  │  │ Service  │  │  Service │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                     数据层 (Data Layer)                    │
│                    MongoDB Database                       │
└─────────────────────────────────────────────────────────┘
```

### 1.2 功能模块划分

```
金融看板系统
├── 核心能力模块
│   ├── 股票信息管理模块
│   ├── 数据聚合模块
│   └── 实时同步模块
├── 支撑型模块
│   ├── 多数据源适配模块
│   ├── BFF 视图模块
│   └── 数据转换模块
└── 可扩展/实验性模块
    ├── 数据分析模块（规划中）
    ├── 用户系统模块（规划中）
    └── 通知模块（规划中）
```

## 2. 核心能力模块

### 2.1 股票信息管理模块

**模块描述**：提供股票信息的完整生命周期管理

**功能点**：
- ✅ **股票查询**：支持列表查询、详情查询、条件筛选
- ✅ **股票更新**：支持单个更新、批量更新、全量更新
- ✅ **股票删除**：支持单个删除、批量删除、全量删除
- ✅ **数据同步**：支持从数据源拉取并保存到数据库

**技术实现**：
- **后端服务**：`py-stock-info-service`（Python FastAPI）
- **数据源**：akshare、yfinance、easyquotation
- **数据存储**：MongoDB

**模块依赖**：
- 依赖：多数据源适配模块
- 被依赖：BFF Stocks 视图、Dashboard 视图

---

### 2.2 数据聚合模块

**模块描述**：聚合多个后端服务的数据，提供统一视图

**功能点**：
- ✅ **Items 聚合**：聚合 Python、Node、Rust 三个服务的 Items 数据
- ✅ **Stocks 聚合**：聚合股票信息服务的数据
- ✅ **Dashboard 聚合**：聚合所有服务的统计信息
- ✅ **数据去重**：按名称去重，保留最新数据
- ✅ **数据排序**：按更新时间排序

**技术实现**：
- **BFF 层**：`bff/bff-main/src/views/`
- **聚合策略**：并行调用 + 容错处理（Promise.allSettled）
- **数据转换**：统一数据格式（UnifiedItem、Stock）

**模块依赖**：
- 依赖：Python Service、Node Service、Rust Service、Stock Service
- 被依赖：前端 Dashboard、Items、Stocks 页面

---

### 2.3 实时同步模块

**模块描述**：提供实时数据同步和进度追踪

**功能点**：
- ✅ **SSE 实时推送**：使用 Server-Sent Events 推送进度
- ✅ **批量更新进度**：实时显示批量操作的进度
- ✅ **错误处理**：部分失败不影响整体进度
- ✅ **进度统计**：显示成功/失败数量、预计剩余时间

**技术实现**：
- **后端服务**：`py-stock-info-service`（`POST /api/v1/stocks/fetch-all`）
- **技术栈**：FastAPI StreamingResponse + SSE
- **进度回调**：异步队列 + 事件推送

**模块依赖**：
- 依赖：股票信息管理模块、多数据源适配模块
- 被依赖：前端 Stocks 页面

---

## 3. 支撑型模块

### 3.1 多数据源适配模块

**模块描述**：支持多个股票数据源，自动切换和容错

**功能点**：
- ✅ **数据源路由**：根据市场类型自动选择数据源
- ✅ **容错机制**：主数据源失败时自动切换到备用数据源
- ✅ **数据源状态**：提供数据源状态查询接口
- ✅ **字段映射**：统一不同数据源的字段格式

**技术实现**：
- **架构模式**：Provider/Adapter 模式
- **数据源**：
  - 第一优先级：akshare（A股）、yfinance（美股/港股）、easyquotation（A股实时）
  - 第二优先级：Tushare、IEX Cloud、Alpha Vantage（规划中）
- **路由逻辑**：`services/py-stock-info-service/app/services/providers/`

**模块依赖**：
- 依赖：无（独立模块）
- 被依赖：股票信息管理模块

---

### 3.2 BFF 视图模块

**模块描述**：为前端提供定制化的视图接口

**功能点**：
- ✅ **Dashboard 视图**：聚合所有服务的统计信息和最近数据
- ✅ **Items 视图**：聚合三个服务的 Items 数据
- ✅ **Stocks 视图**：聚合股票信息服务的数据
- ✅ **统一响应格式**：所有接口返回统一格式 `{ code, message, data }`
- ✅ **错误处理**：统一错误响应格式

**技术实现**：
- **BFF 层**：`bff/bff-main/src/views/`
- **HTTP 客户端**：`bff/bff-main/src/clients/`
- **数据转换**：`bff/bff-main/src/common/utils/transform.util.ts`

**模块依赖**：
- 依赖：Python Service、Node Service、Rust Service、Stock Service
- 被依赖：前端所有页面

---

### 3.3 数据转换模块

**模块描述**：统一不同服务的数据格式

**功能点**：
- ✅ **Items 格式转换**：Python/Node/Rust Items → UnifiedItem
- ✅ **Stocks 格式转换**：不同数据源的 Stock → 统一 Stock 格式
- ✅ **字段映射**：处理字段名差异（如 `_id` → `id`、`updated_at` → `updatedAt`）
- ✅ **数据清洗**：处理空值、默认值、类型转换

**技术实现**：
- **工具函数**：`bff/bff-main/src/common/utils/transform.util.ts`
- **转换函数**：
  - `transformPythonItem()`、`transformNodeItem()`、`transformRustItem()`
  - `mergeAndDeduplicateItems()`、`sortItemsByUpdatedAt()`

**模块依赖**：
- 依赖：无（工具模块）
- 被依赖：BFF 视图模块

---

## 4. 可扩展/实验性模块

### 4.1 数据分析模块（规划中）

**模块描述**：提供股票数据分析和可视化

**功能点**（规划）：
- 🔮 **价格趋势分析**：展示股票价格变化趋势
- 🔮 **数据对比**：对比不同股票的指标
- 🔮 **统计图表**：柱状图、折线图、饼图等
- 🔮 **数据导出**：支持 CSV、Excel 格式导出

**技术实现**（规划）：
- **前端**：使用 Chart.js 或 ECharts
- **后端**：数据分析服务（可选）

---

### 4.2 用户系统模块（规划中）

**模块描述**：支持多用户、权限管理

**功能点**（规划）：
- 🔮 **用户注册/登录**：JWT 认证
- 🔮 **权限管理**：角色和权限控制
- 🔮 **个人设置**：用户偏好配置
- 🔮 **数据隔离**：用户数据隔离

**技术实现**（规划）：
- **认证**：JWT Token
- **数据库**：用户表、角色表、权限表

---

### 4.3 通知模块（规划中）

**模块描述**：提供价格预警和通知功能

**功能点**（规划）：
- 🔮 **价格预警**：设置价格阈值，触发通知
- 🔮 **邮件通知**：发送邮件通知
- 🔮 **WebSocket 推送**：实时推送通知
- 🔮 **通知历史**：查看通知历史记录

**技术实现**（规划）：
- **后端**：定时任务 + 消息队列
- **前端**：WebSocket 客户端

---

## 5. 模块关系图

### 5.1 依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                    前端层                                │
│  Dashboard  Stocks  Items  Settings                      │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    BFF 层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │Dashboard │  │  Stocks  │  │  Items   │              │
│  │  View    │  │  View    │  │  View    │              │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘              │
│       │             │              │                     │
│       └─────────────┴──────────────┘                     │
│                   数据转换模块                            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   后台服务层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │  Python  │  │   Node    │  │   Rust   │  │  Stock   │ │
│  │ Service  │  │  Service  │  │ Service  │  │  Service │ │
│  └──────────┘  └──────────┘  └──────────┘  └─────┬─────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────┐
│              股票信息管理模块                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │  查询    │  │  更新    │  │  删除    │              │
│  └──────────┘  └─────┬────┘  └──────────┘              │
│                      │                                  │
│                      ↓                                  │
│            ┌──────────────────┐                        │
│            │ 多数据源适配模块  │                        │
│            │ akshare/yfinance │                        │
│            └──────────────────┘                        │
└─────────────────────────────────────────────────────────┘
```

### 5.2 数据流

```
用户操作
  ↓
前端页面
  ↓
BFF 视图（数据聚合、格式转换）
  ↓
后台服务（Python/Node/Rust/Stock）
  ↓
数据层（MongoDB）
```

---

## 6. 模块协作方式

### 6.1 数据聚合流程

**场景**：前端请求 Dashboard 数据

1. **前端**：`GET /api/bff/v1/views/dashboard`
2. **BFF Dashboard View**：
   - 并行调用 Python/Node/Rust/Stock 服务
   - 使用 `Promise.allSettled` 处理部分失败
   - 聚合统计数据
   - 获取最近 Items 和 Stocks
3. **后台服务**：返回各自的数据
4. **BFF**：统一数据格式，返回给前端

### 6.2 数据更新流程

**场景**：批量更新股票数据

1. **前端**：`POST /api/v1/stocks/fetch-all?delay=1.0`
2. **Stock Service**：
   - 获取股票代码列表（多数据源）
   - 批量抓取股票信息（yfinance Tickers）
   - 实时推送进度（SSE）
   - 保存到数据库
3. **前端**：通过 EventSource 接收进度更新

### 6.3 容错处理流程

**场景**：某个数据源失败

1. **多数据源适配模块**：
   - 尝试主数据源（如 akshare）
   - 如果失败，自动切换到备用数据源（如 yfinance）
   - 记录错误日志
2. **BFF 层**：
   - 使用 `Promise.allSettled` 允许部分服务失败
   - 返回成功的数据，失败的字段为 `null` 或默认值
3. **前端**：
   - 显示可用数据
   - 提示部分数据不可用（可选）

---

## 7. 模块优先级

### 7.1 核心模块（P0 - 必须）

- ✅ **股票信息管理模块**：核心功能，必须完成
- ✅ **数据聚合模块**：BFF 层核心，必须完成
- ✅ **多数据源适配模块**：数据源支持，必须完成
- ✅ **BFF 视图模块**：前端接口，必须完成

### 7.2 重要模块（P1 - 重要）

- ✅ **实时同步模块**：提升用户体验，重要
- ✅ **数据转换模块**：数据格式统一，重要

### 7.3 可选模块（P2 - 可选）

- 🔮 **数据分析模块**：增强功能，可选
- 🔮 **用户系统模块**：多用户支持，可选
- 🔮 **通知模块**：价格预警，可选

---

## 8. 技术债务与改进方向

### 8.1 当前技术债务

- ⚠️ **错误处理**：部分错误处理不够完善，需要统一错误响应格式
- ⚠️ **缓存策略**：当前没有缓存，可以考虑添加 Redis 缓存
- ⚠️ **日志系统**：需要完善的日志系统，便于排查问题
- ⚠️ **监控告警**：需要添加系统监控和告警

### 8.2 改进方向

- 🔧 **性能优化**：添加缓存、优化数据库查询
- 🔧 **安全性**：添加认证、授权、输入验证
- 🔧 **可观测性**：添加日志、监控、链路追踪
- 🔧 **测试覆盖**：提高单元测试和集成测试覆盖率

---

**文档维护**：本文档将根据功能发展持续更新
