# 异常处理规范

## 异常分类

| 类型 | 说明 | 是否可重试 | 建议 HTTP/code |
|------|------|------------|----------------|
| **参数校验异常** | 缺少必填、格式错误、枚举非法 | 否 | 400 |
| **资源不存在** | 股票未找到、Provider 未注册 | 否 | 404 |
| **限流** | 应用或下游限流 | 是（稍后重试） | 429 |
| **超时** | 单次 Provider 调用超时 | 是 | 视为失败，尝试下一 Provider 或最终 503 |
| **下游不可用** | 网络错误、下游 5xx、连接拒绝 | 是 | 尝试下一 Provider 或 503 |
| **下游 4xx** | 下游返回 4xx（如参数错误） | 否 | 不重试当前 Provider，尝试下一个或返回 400/404 |
| **配置/启动错误** | 凭证缺失、至少一个第一优先级未启用 | 否 | 启动失败或 503 |

## 抛出与捕获

### API 层

- **职责**：捕获应用服务层或路由层抛出的业务异常，映射为 [error-codes.md](error-codes.md) 中的 code 与 HTTP 状态，并封装为统一响应格式 `{ code, message, data: null [, detail] }`。
- **未捕获异常**：不应将堆栈或内部错误信息返回给调用方；记录日志（含 trace_id）后返回 500 或 503 及通用 message。

### 路由层（Router）

- **职责**：调用 Provider 时捕获超时与异常；将「当前 Provider 失败」视为可继续尝试，不向上抛出业务异常，直至某 Provider 成功或全部耗尽。
- **耗尽时**：向上返回 null 或抛出「无可用数据」类异常，由应用层/API 层映射为 404 或 503。
- **可重试与不可重试**：下游 4xx 或「参数错误」类不重试当前 Provider；超时、5xx、网络错误可重试（次数见配置），再尝试下一 Provider。

### Provider 层

- **职责**：调用外部 API 时捕获超时、网络异常、解析异常；可抛出「当前数据源不可用」或返回 null/空数组，由路由层处理。
- **不泄露**：不在异常 message 中暴露凭证明文或内部路径；日志中可记录错误类型与 trace_id，便于排查。

## 日志约定

- **级别**：参数错误 400 可打 INFO 或 WARN；404/503 打 WARN；未捕获异常打 ERROR。
- **内容**：至少包含请求标识（如 trace_id）、错误类型、必要时 provider.name、ticker、market；不记录敏感信息。
- **与 OpenTelemetry**：异常发生时在 Span 上记录 exception 与 stack（见 [observability](../observability/opentelemetry.md)），便于追踪与告警。

## 响应映射表（实现参考）

| 异常/结果 | API 层返回 |
|-----------|------------|
| 参数校验失败 | 400, message 描述缺失或非法参数 |
| Router 返回 null（单只股票） | 404 或 503（实现可统一为 404「未找到」或 503「暂不可用」） |
| Router 返回 null（列表/K 线可空） | 200，data 为空数组或空结构 |
| 全部 Provider 失败 | 503，message 如「数据源暂不可用」 |
| 指定 data_source 不可用或不支持 | 404 或 503 |
| 限流 | 429，message 如「请求过于频繁」 |
| 未捕获异常 | 500 或 503，message 通用，不含堆栈 |
