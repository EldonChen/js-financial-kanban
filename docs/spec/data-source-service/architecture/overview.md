# 架构总览

## 分层结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ API 层 (Controller / HTTP)                                                   │
│ - 接收请求、参数校验、调用应用服务、封装统一响应格式、错误码映射               │
└───────────────────────────────────────────┬─────────────────────────────────┘
                                            │
┌───────────────────────────────────────────▼─────────────────────────────────┐
│ 应用服务层 (Application Service)                                            │
│ - 编排：根据请求参数调用 Router，获取结果后按契约返回                          │
│ - 不直接依赖具体 Provider，仅依赖 Router 与领域模型                           │
└───────────────────────────────────────────┬─────────────────────────────────┘
                                            │
┌───────────────────────────────────────────▼─────────────────────────────────┐
│ 路由/转发层 (Router)                                                        │
│ - 根据 market、data_source、feature、优先级 选择 Provider                    │
│ - 动态调度：按优先级依次调用 Provider，直至成功或耗尽（容错）                  │
│ - 依赖：Registry（注册表）、Provider 抽象接口                                 │
└───────────────────────────────────────────┬─────────────────────────────────┘
                                            │
┌───────────────────────────────────────────▼─────────────────────────────────┐
│ Provider 层 (插件)                                                           │
│ - 实现统一接口 IStockMetaProvider / IKlineProvider（或合并接口）               │
│ - 职责：调用外部 API → 原始响应经 FieldMapper 映射为统一模型 → 返回             │
│ - 每个外部数据源一个实现类，可独立开发、测试、注册                             │
└───────────────────────────────────────────┬─────────────────────────────────┘
                                            │
┌───────────────────────────────────────────▼─────────────────────────────────┐
│ 外部数据源 (yfinance / akshare / Tushare / ...)                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心抽象

| 抽象 | 职责 | 扩展方式 |
|------|------|----------|
| **IRegistry** | 存储与查找 Provider，按 name / market / feature 查询 | 实现类可替换为内存 Map 或扩展为分布式发现（未来） |
| **IStockMetaProvider** | 股票元信息与列表能力 | 新增数据源 = 新实现类 + 配置注册 |
| **IKlineProvider** | 历史 K 线能力 | 同上 |
| **IFieldMapper** | 原始响应 → 统一模型（Stock / Kline） | 每数据源可绑定专属 Mapper 或共用通用 Mapper |
| **IRouter** | 根据请求参数选择 Provider 并执行转发与容错 | 依赖 IRegistry 与 Provider 接口，策略可配置 |

## 动态注册与扩展

- **注册时机**：启动时从配置读取已启用 Provider 列表，实例化后调用 `Registry.register(provider)`。
- **扩展新数据源**：实现 `IStockMetaProvider` 和/或 `IKlineProvider` → 在配置中启用并设置凭证/优先级 → 重启或热加载后即可被路由层调度，无需改路由代码。
- **能力声明**：每个 Provider 声明 `supported_markets` 与 `features`，路由层仅将匹配的请求派发给它。

## 可观测性

- 路由层与 Provider 层关键路径需与 [observability](../observability/opentelemetry.md) 规范集成：Trace、Span、属性（provider.name、market、feature）等，便于全链路追踪与排障。
