# 技术路线 - 股票基本信息模块多数据源支持

> **任务状态**：进行中  
> **创建时间**：2024年  
> **文档位置**：docs/  
> **说明**：本文档仅用于当前任务，任务完成后可归档或删除

## 任务概述

为股票基本信息模块支持多个数据来源，提升健壮性、可用性与市场覆盖范围。

## 任务拆解

### 阶段 1：数据源调研与评估（进行中）

#### 任务 1.1：调研股票数据 API
- **状态**：✅ 已完成（扩展版）
- **描述**：调研适用于不同股票市场的股票基本信息 API
- **范围**：
  - **A 股市场**：Tushare、akshare、easyquotation、stock-api、东方财富网、聚宽数据、米筐数据
  - **美股市场**：yfinance、Alpha Vantage、IEX Cloud、Polygon.io、Finnhub
  - **港股市场**：yfinance、akshare、富途 API、雪球 API
  - **通用平台**：聚宽数据、米筐数据、掘金数据
- **输出**：数据源调研报告（`docs/数据源调研报告.md`，v2.0 扩展版，包含 12+ 个数据源）

#### 任务 1.2：评估数据源并制定选型方案
- **状态**：✅ 已完成
- **描述**：对比评估各数据源，制定推荐方案
- **评估维度**：
  - 支持的市场类型
  - 是否支持全量股票列表
  - 基本信息字段完整度
  - 访问限制（频率、认证、IP 限制）
  - 可维护性（社区活跃度、更新频率）
  - 商业与使用限制
- **优先级策略**：
  - **第一优先级**：免费优先、无需认证（akshare、yfinance、easyquotation）
  - **第二优先级**：需要注册 API Key，存在限制（Tushare、IEX Cloud、Alpha Vantage 等）
- **输出**：数据源评估报告和推荐方案（已在技术方案中确定）

### 阶段 2：架构设计

#### 任务 2.1：设计数据源抽象层
- **状态**：✅ 已完成
- **描述**：设计 Provider/Adapter 模式的数据源抽象层
- **内容**：
  - 定义 `StockDataProvider` 接口（`app/services/providers/base.py`）
  - 设计数据源路由器（Router）（`app/services/providers/router.py`）
  - 设计容错和切换机制
  - 实现字段映射器（`app/services/providers/field_mapper.py`）
- **输出**：
  - `app/services/providers/base.py` - 数据源抽象基类
  - `app/services/providers/router.py` - 数据源路由器
  - `app/services/providers/field_mapper.py` - 字段映射器

#### 任务 2.2：设计数据模型扩展
- **状态**：✅ 已完成
- **描述**：扩展股票数据模型，支持多市场字段
- **内容**：
  - 评估现有字段是否足够通用
  - 设计扩展字段（市场类型、上市日期、财务指标等）
  - 设计字段映射策略
  - 更新 MongoDB 模型（`app/models/stock.py`）
  - 更新 Pydantic Schema（`app/schemas/stock.py`）
  - 更新数据库索引（支持 market_type 查询）
- **输出**：
  - 更新后的 `app/models/stock.py` - 支持新字段
  - 更新后的 `app/schemas/stock.py` - 支持新字段
  - 新增数据库索引（market_type、market_type + market）

### 阶段 3：数据源适配器实现

#### 第一优先级：免费优先、无需认证（必须实现）

#### 任务 3.1：实现 AkshareProvider（A 股主数据源）
- **状态**：✅ 已完成
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：实现 akshare 数据源适配器，作为 A 股主数据源
- **内容**：
  - ✅ 安装 akshare 依赖（已添加到 pyproject.toml）
  - ✅ 实现 `AkshareProvider` 类（`app/services/providers/akshare_provider.py`）
  - ✅ 实现 `StockDataProvider` 接口
  - ✅ 实现字段映射（使用 FieldMapper）
  - ✅ 实现全量股票列表获取（A 股、港股）
  - ✅ 实现股票基本信息获取（A 股、港股）
- **输出**：AkshareProvider 实现

#### 任务 3.2：实现 YFinanceProvider（重构现有代码）
- **状态**：✅ 已完成
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：将现有 yfinance 代码重构为 Provider 模式，作为美股/港股主数据源
- **内容**：
  - ✅ 创建 `YFinanceProvider` 类（`app/services/providers/yfinance_provider.py`）
  - ✅ 实现 `StockDataProvider` 接口
  - ✅ 保持现有功能不变（复用 `yfinance_service.py` 中的函数）
  - ✅ 实现字段映射（使用 FieldMapper）
- **输出**：YFinanceProvider 实现

#### 任务 3.3：实现 EasyQuotationProvider（A 股实时行情补充）
- **状态**：✅ 已完成
- **优先级**：⭐⭐⭐（可选，仅用于实时行情）
- **描述**：实现 easyquotation 数据源适配器，作为 A 股实时行情补充
- **内容**：
  - ✅ 安装 easyquotation 依赖（已添加到 pyproject.toml）
  - ✅ 实现 `EasyQuotationProvider` 类（`app/services/providers/easyquotation_provider.py`）
  - ✅ 实现 `StockDataProvider` 接口
  - ✅ 实现字段映射（使用 FieldMapper）
  - ✅ **注意**：不支持全量股票列表，仅用于实时行情补充
- **输出**：EasyQuotationProvider 实现

#### 第二优先级：需要注册 API Key，存在限制（可选实现）

#### 任务 3.4：实现 TushareProvider（可选）
- **状态**：待开始
- **优先级**：⭐⭐⭐（可选，如果已配置 token）
- **描述**：实现 Tushare 数据源适配器，作为 A 股备用数据源
- **内容**：
  - 安装 Tushare 依赖
  - 实现 `TushareProvider` 类
  - 实现 `StockDataProvider` 接口
  - 实现字段映射
  - 实现全量股票列表获取
  - **前提条件**：需要配置 Tushare token
- **输出**：TushareProvider 实现

#### 任务 3.5：实现 IEXCloudProvider（可选）
- **状态**：待开始
- **优先级**：⭐⭐⭐（可选，如果已配置 API Key）
- **描述**：实现 IEX Cloud 数据源适配器，作为美股备用数据源
- **内容**：
  - 安装 IEX Cloud SDK 或使用 requests
  - 实现 `IEXCloudProvider` 类
  - 实现 `StockDataProvider` 接口
  - 实现字段映射
  - 实现全量股票列表获取
  - **前提条件**：需要配置 IEX Cloud API Key
- **输出**：IEXCloudProvider 实现

#### 任务 3.6：实现 AlphaVantageProvider（可选）
- **状态**：待开始
- **优先级**：⭐⭐（可选，如果已配置 API Key）
- **描述**：实现 Alpha Vantage 数据源适配器，作为美股备用数据源
- **内容**：
  - 安装 Alpha Vantage SDK
  - 实现 `AlphaVantageProvider` 类
  - 实现 `StockDataProvider` 接口
  - 实现字段映射
  - **前提条件**：需要配置 Alpha Vantage API Key
- **输出**：AlphaVantageProvider 实现

### 阶段 4：数据源路由器实现

#### 任务 4.1：实现 StockDataRouter
- **状态**：✅ 已完成（已在阶段2完成）
- **描述**：实现数据源路由器，支持按市场选择数据源和容错
- **内容**：
  - ✅ 实现数据源注册机制（`app/services/providers/router.py`）
  - ✅ 实现按市场选择数据源
  - ✅ 实现容错和自动切换
  - ✅ 实现数据源可用性检测
- **输出**：StockDataRouter 实现（`app/services/providers/router.py`）

#### 任务 4.2：实现字段映射器
- **状态**：✅ 已完成（已在阶段2完成）
- **描述**：实现统一字段映射，将不同数据源字段映射到统一格式
- **内容**：
  - ✅ 创建 `FieldMapper` 类（`app/services/providers/field_mapper.py`）
  - ✅ 为每个数据源实现映射方法（yfinance、akshare、tushare、easyquotation）
  - ✅ 处理字段缺失和类型转换
- **输出**：FieldMapper 实现（`app/services/providers/field_mapper.py`）

#### 任务 4.3：实现数据源初始化模块
- **状态**：✅ 已完成
- **描述**：创建数据源初始化模块，在应用启动时注册所有数据源
- **内容**：
  - ✅ 创建 `initializer.py` 模块（`app/services/providers/initializer.py`）
  - ✅ 实现 `initialize_providers` 函数
  - ✅ 更新 `config.py` 添加数据源配置选项
  - ✅ 更新 `main.py` 在应用启动时初始化数据源
  - ✅ 更新 `.env.example` 添加配置说明
- **输出**：
  - 数据源初始化模块（`app/services/providers/initializer.py`）
  - 更新的配置文件（`app/config.py`）
  - 更新的应用入口（`app/main.py`）
  - 更新的环境变量示例（`.env.example`）

### 阶段 5：服务层集成

#### 任务 5.1：更新 StockService
- **状态**：✅ 已完成
- **描述**：更新服务层，集成数据源路由器
- **内容**：
  - ✅ 添加 `router` 参数到 `StockService.__init__`
  - ✅ 新增 `update_stock_from_provider` 方法（支持多数据源）
  - ✅ 保留 `update_stock_from_yfinance` 方法（向后兼容）
  - ✅ 新增 `fetch_and_save_all_stocks_from_provider` 方法（支持多数据源）
  - ✅ 保留 `fetch_and_save_all_stocks_from_yahoo` 方法（向后兼容）
  - ✅ 更新 `update_all_stocks` 和 `batch_update_stocks` 使用路由器
  - ✅ 支持指定首选数据源
  - ✅ 支持按市场选择数据源
- **输出**：更新后的 StockService（`app/services/stock_service.py`）

#### 任务 5.2：更新数据模型和 Schema
- **状态**：✅ 已完成（已在阶段2完成）
- **描述**：扩展数据模型，支持新字段
- **内容**：
  - ✅ 更新 MongoDB 模型（`prepare_stock_document`）
  - ✅ 更新 Pydantic Schema（`StockBase`, `StockResponse`, `StockQueryParams`）
  - ✅ 更新数据库索引（market_type、market_type + market）
- **输出**：更新后的数据模型和 Schema

#### 任务 5.3：更新路由层
- **状态**：✅ 已完成
- **描述**：更新路由层，支持多数据源参数
- **内容**：
  - ✅ 更新 `get_stocks` 路由，支持 `market_type` 查询参数
  - ✅ 更新 `update_stock` 路由，支持 `market` 和 `preferred_provider` 参数
  - ✅ 更新 `fetch_all_stocks` 路由，支持 `market` 参数
  - ✅ 保持向后兼容性
- **输出**：更新后的路由层（`app/routers/stocks.py`）

### 阶段 6：配置和初始化

#### 任务 6.1：添加数据源配置
- **状态**：✅ 已完成
- **描述**：添加数据源相关配置（API Key、优先级等）
- **内容**：
  - ✅ 更新 `.env.example`（已添加数据源配置说明）
  - ✅ 更新 `config.py`（已添加数据源配置选项）
  - ✅ **第一优先级数据源**：无需配置，默认启用
  - ✅ **第二优先级数据源**：支持可选配置（未配置的数据源自动跳过）
  - ✅ 创建配置验证器（`app/services/providers/config_validator.py`）
- **输出**：
  - 配置文件（`app/config.py`）
  - 环境变量示例（`.env.example`）
  - 配置验证器（`app/services/providers/config_validator.py`）

#### 任务 6.2：实现数据源初始化
- **状态**：✅ 已完成
- **描述**：在应用启动时初始化数据源
- **内容**：
  - ✅ 创建数据源初始化模块（`app/services/providers/initializer.py`）
  - ✅ 在 `main.py` 中初始化数据源路由器
  - ✅ 注册所有可用的数据源
  - ✅ 配置市场到数据源的映射
  - ✅ 添加配置验证（启动时验证配置有效性）
  - ✅ 添加数据源状态查询 API（`/api/v1/providers/status`）
- **输出**：
  - 数据源初始化模块（`app/services/providers/initializer.py`）
  - 更新的应用入口（`app/main.py`）
  - 数据源管理路由（`app/routers/providers.py`）

### 阶段 7：测试

#### 任务 7.1：编写单元测试
- **状态**：✅ 已完成
- **描述**：为数据源适配器和路由器编写单元测试
- **内容**：
  - ✅ 测试每个 Provider 的实现（`tests/test_providers.py`）
    - TestAkshareProvider：测试 akshare 数据源
    - TestYFinanceProvider：测试 yfinance 数据源
    - TestEasyQuotationProvider：测试 easyquotation 数据源
  - ✅ 测试 Router 的数据源选择逻辑（`tests/test_router.py`）
    - 测试数据源注册
    - 测试按优先级排序
    - 测试首选数据源
    - 测试容错和自动切换
  - ✅ 测试字段映射（`tests/test_field_mapper.py`）
    - 测试各数据源的字段映射
    - 测试日期解析
    - 测试字段清洗
- **输出**：
  - `tests/test_providers.py` - 数据源提供者单元测试
  - `tests/test_router.py` - 数据源路由器单元测试
  - `tests/test_field_mapper.py` - 字段映射器单元测试

#### 任务 7.2：编写集成测试
- **状态**：✅ 已完成
- **描述**：编写集成测试，验证多数据源切换
- **内容**：
  - ✅ 测试不同市场的股票获取（`tests/test_provider_integration.py`）
  - ✅ 测试数据源故障时的自动切换
  - ✅ 测试全量股票列表获取
  - ✅ 测试 StockService 的多数据源功能（`tests/test_stock_service.py`）
    - 测试 update_stock_from_provider
    - 测试按市场类型选择数据源
    - 测试首选数据源功能
    - 测试数据验证机制
- **输出**：
  - `tests/test_provider_integration.py` - 数据源集成测试
  - 更新的 `tests/test_stock_service.py` - StockService 多数据源测试

### 阶段 8：文档和部署

#### 任务 8.1：更新 API 文档
- **状态**：✅ 已完成
- **描述**：更新 API 文档，说明多数据源支持
- **内容**：
  - ✅ 创建 API 文档（`docs/API文档-股票信息服务.md`）
  - ✅ 更新接口说明（包含多数据源参数）
  - ✅ 添加数据源选择参数说明
  - ✅ 添加配置说明
  - ✅ 添加使用示例
- **输出**：
  - `docs/API文档-股票信息服务.md` - 完整的 API 文档

#### 任务 8.2：更新 README 和配置说明
- **状态**：✅ 已完成
- **描述**：更新项目文档，说明如何配置和使用多数据源
- **内容**：
  - ✅ 更新 `services/py-stock-info-service/README.md`
    - 添加多数据源支持说明
    - 添加数据源配置说明
    - 添加使用示例
    - 更新项目结构
    - 更新 API 端点说明
  - ✅ 更新主项目 `README.md`
    - 添加股票信息服务说明
    - 添加相关文档链接
  - ✅ 添加环境变量说明（已在 `.env.example` 中）
- **输出**：
  - 更新的 `services/py-stock-info-service/README.md`
  - 更新的主项目 `README.md`

## 任务依赖关系

```
阶段 1（调研） → 阶段 2（设计） → 阶段 3（适配器） → 阶段 4（路由器）
                                                      ↓
阶段 5（服务层） ← 阶段 4（路由器） ← 阶段 3（适配器）
     ↓
阶段 6（配置） → 阶段 7（测试） → 阶段 8（文档）
```

## 实施优先级

### 第一阶段：核心数据源（必须实现）

1. **AkshareProvider**（A 股主数据源）
2. **YFinanceProvider**（美股/港股主数据源，重构现有代码）

### 第二阶段：增强数据源（推荐实现）

3. **EasyQuotationProvider**（A 股实时行情补充，可选）
4. **数据源路由器**（StockDataRouter）
5. **字段映射器**（FieldMapper）

### 第三阶段：可选数据源（按需实现）

6. **TushareProvider**（如果已配置 token）
7. **IEXCloudProvider**（如果已配置 API Key）
8. **AlphaVantageProvider**（如果已配置 API Key）

## 注意事项

1. **向后兼容**：确保现有 API 接口保持兼容，不破坏现有功能
2. **配置可选**：数据源配置应该是可选的，未配置的数据源自动跳过
3. **错误处理**：数据源失败时应该有清晰的错误日志
4. **性能考虑**：数据源切换不应该显著影响性能
5. **测试覆盖**：确保所有数据源都有测试覆盖

## 检查清单

### 第一阶段：核心功能
- [x] 数据源调研完成
- [x] 数据源选型方案确定（免费优先、无需认证为第一优先级）
- [ ] 架构设计完成
- [ ] AkshareProvider 实现完成（第一优先级）
- [ ] YFinanceProvider 实现完成（第一优先级，重构现有代码）
- [ ] 数据源路由器实现完成
- [ ] 字段映射器实现完成
- [ ] 服务层集成完成

### 第二阶段：增强功能
- [ ] EasyQuotationProvider 实现完成（可选）
- [ ] 配置和初始化完成
- [ ] 单元测试通过
- [ ] 集成测试通过

### 第三阶段：可选功能
- [ ] TushareProvider 实现完成（可选，如果已配置 token）
- [ ] IEXCloudProvider 实现完成（可选，如果已配置 API Key）
- [ ] AlphaVantageProvider 实现完成（可选，如果已配置 API Key）

### 文档和部署
- [ ] 文档更新完成
- [ ] API 文档更新完成
