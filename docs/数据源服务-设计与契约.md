# 数据源服务 - 设计与契约

> **文档类型**：设计文档（不涉及实现）  
> **适用范围**：数据源服务作为**统一 Proxy**的定位与职责、对外 API 契约、统一数据模型、Provider 抽象与配置、迁移要点  
> **用途**：供实现 issue 与验收使用

---

## 1. 架构与职责

### 1.1 定位与目标

数据源服务（Data Source Service）的定位为：**作为统一的 Proxy**，将各种请求转发到实际的各个 data provider，并将结果转换成统一的数据模型，返回给调用方。

具体而言：

- **转发**：接收上游（股票信息服务、历史数据服务、指标服务等）的标准化请求，按市场/优先级/指定数据源，将请求**转发**到对应的外部 data provider（yfinance、akshare、Tushare 等）。
- **转换**：各 provider 的原始响应在服务内完成字段映射与清洗，**转换成统一数据模型**（股票元信息、K 线等），与具体数据源解耦。
- **返回**：将统一模型通过 HTTP API / SDK CALL / RPC CALL **返回给调用方**，调用方无需关心数据来自哪个 provider。

目标：**单一职责**——只做「转发 → 取数 → 转换 → 返回」，不做业务持久化、调度、指标计算等。

### 1.2 在整体架构中的位置

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                    调用方（上游）                         │
                    │  股票信息服务 │ 历史数据服务 │ 指标服务 │ 其他服务        │
                    └───────────────────────────┬─────────────────────────────┘
                                                │ HTTP / 内部调用 / RPC CALL
                                                ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│           数据源服务 (Data Source Service) — 统一 Proxy                        │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────────────────┐  │
│  │ API 层            │ │ 路由/转发层       │ │ Provider 层                   │  │
│  │ 统一契约          │ │ 数据源选择、      │ │ yfinance / akshare / …       │  │
│  │ · 能力查询        │ │ 优先级、容错      │ │ 转发请求 → 字段映射与清洗     │  │
│  │   (provider/      │ │ (Router+Provider │ │ → 统一数据模型（元信息/列表/  │  │
│  │    feature)       │ │  抽象)           │ │   K 线）                      │  │
│  │ · 元信息/列表/K线 │ │                  │ │ 凭证与限流（见配置）          │  │
│  └──────────────────┘ └──────────────────┘ └──────────────────────────────┘  │
└───────────────────────────────────────┬─────────────────────────────────────┘
                                        │ 调用外部 API / 库
                                        ▼
                    ┌─────────────────────────────────────────────────────────┐
                    │                    外部数据源（下游）                     │
                    │  yfinance │ akshare │ easyquotation │ Tushare │ ...      │
                    └─────────────────────────────────────────────────────────┘
```

- **谁调用数据源服务**：股票信息服务（需元信息、列表）、历史数据服务（需 K 线）、指标服务（若需原始行情时）、未来可能的其他服务。
- **数据源服务提供什么**：作为统一 Proxy，接收上述请求并转发至各 data provider，将返回结果转换为统一模型后提供给调用方；契约与数据模型见「2. 对外 API 契约」与「3. 统一数据模型」。

### 1.3 职责边界

| 职责 | 归属 | 说明 |
| 查询系统支持的数据源与能力 | 数据源服务 | 允许用户按「provider」（数据源接入情况）和「feature」（功能支持情况）两个维度，查询当前系统支持哪些数据源及其功能 |
| 获取股票元信息（单只/批量） | 数据源服务 | 从外部源拉取并映射为统一模型 |
| 获取股票代码列表（按市场） | 数据源服务 | 从外部源拉取列表 |
| 获取历史 K 线（按标的、周期、区间） | 数据源服务 | 从外部源拉取并映射为统一 K 线模型 |
| 数据源选择、优先级、容错 | 数据源服务 | Router + Provider 抽象 |
| 字段映射与清洗 | 数据源服务 | 各 Provider 内或统一 FieldMapper |
| 凭证与限流配置 | 数据源服务 | 配置模型，见「5. 配置」 |
| 股票/ K 线持久化、缓存 | 非数据源服务 | 由股票信息服务、历史数据服务等负责 |
| 定时任务、调度 | 非数据源服务 | 由各业务服务或调度服务负责 |
| 指标计算 | 非数据源服务 | 指标服务 |

### 1.4 与现有 py-stock-info-service 的对照与迁移要点

#### 现有逻辑分布及迁移方向

| 现有位置 | 现状 | 迁移后 |
|----------|------|--------|
| `app/services/providers/*` | Provider 实现、路由、字段映射等逻辑混杂 | 迁入数据源服务「Provider 层」，实现与外部数据源的适配及字段清洗，与上游解耦 |
| `app/services/historical_data/historical_data_fetcher.py` | 直接拉取外部 K 线数据，业务服务和数据源耦合 | 统一由数据源服务提供「历史 K 线」API，上游历史数据服务仅调用该 API，实现清晰职责边界 |
| `app/services/stock_service.py` | 通过内部路由等机制获取元信息/代码列表，含部分业务逻辑 | 通过 HTTP/RPC 方式调用数据源服务的「股票元信息」「股票列表」等接口，彻底与外部 provider 解耦 |
| `app/routers/providers.py` | 仅实现 `/api/v1/providers/status`，契约不完整 | 数据源服务对外暴露完整 API 契约（见第 2 节）；能力/数据源支持状态集中由数据源服务维护 |
| `app/config.py` / `config_validator` | 数据源、凭证、限流等配置分散 | 合并并归入数据源服务专属配置体系，统一维护所有 provider 的开关、凭证、限流等参数（见「5. 配置」） |

#### 迁移与集成建议

- 数据源服务作为「统一 Proxy」，直接对上游（如股票信息服务、历史数据服务、指标服务等）提供 HTTP/RPC/SDK 接口。所有元信息、列表、K线等数据能力都统一通过数据源服务对接，彻底屏蔽上游对具体数据源（yfinance/akshare等）的直接依赖与耦合，实现单一职责。
- 在短期内如需与现有服务共进程内运行，可将数据源服务以「独立模块」方式集成。无论部署模式如何，均需严格按照本文档规定的对外契约进行接口设计与调用，以保证未来平滑拆分为独立服务。
- 数据源服务**不负责持久化、指标计算、调度等业务逻辑**，其职责边界明确：只做“转发→取数→统一映射→返回”。
- 如有与现有系统实现/契约不兼容之处，需在具体迁移与实现文档中逐项列明，并给出详细迁移路径和兼容策略，以确保平滑演进和向后兼容。
- 未来如需适配新数据源或扩展能力，仅需在数据源服务内部扩展 provider 层实现及配置，无需变更上游调用方。

---

## 2. 对外 API 契约

数据源服务作为统一 Proxy，对外暴露标准化接口。调用方可通过 **HTTP**、**RPC** 或 **SDK** 调用（具体以部署与实现为准）；以下以 HTTP 为例约定路径与报文格式。

### 2.1 通用约定

- **Base URL**：`/api/v1`（或部署时前缀，如 `https://data-source.example.com/api/v1`）；RPC/SDK 的命名空间与本文档能力一一对应。
- **统一响应格式**：
  - 成功：`{ "code": 200, "message": "success", "data": { ... } }`
  - 失败：`{ "code": <错误码>, "message": "<描述>", "data": null }`
- **日期时间**：日期格式 `YYYY-MM-DD`；时间戳 ISO 8601（如 `2024-01-15T09:30:00Z`）。
- **限流**：见「2.5 限流与错误码」。

### 2.2 能力列表与路径

| 能力 | 方法 | 路径 | 简要说明 |
|------|------|------|----------|
| 能力查询（数据源与功能） | GET | `/providers/status` 或 `/providers/capabilities` | 按「provider」与「feature」两维度查询：当前已注册数据源、各数据源支持的市场与优先级、各数据源支持的能力（元信息/列表/K 线等），见 §1.3 |
| 股票元信息（单只） | GET | `/stocks/{ticker}` | 按代码取单只股票统一模型，可选 market / data_source |
| 股票元信息（批量） | POST | `/stocks/batch` | 批量查询，请求体为 tickers + 可选 market / data_source |
| 股票列表（按市场） | GET | `/stocks/list` | 按市场返回股票代码列表，可选 data_source |
| 历史 K 线 | GET | `/kline/{ticker}` | 按 ticker、周期、起止日期取 K 线 |

以上为数据源服务**必须**提供的能力；实现时可增加健康检查等运维接口。

**OpenAPI 草稿**：见同目录 `数据源服务-API契约-OpenAPI.yaml`，可与本文档第 2 节对照使用。

### 2.3 请求/响应示例

#### 2.3.1 股票元信息（单只）

**请求**  
`GET /api/v1/stocks/{ticker}?market=A股&data_source=akshare`

| 参数 | 位置 | 类型 | 必填 | 说明 |
|------|------|------|------|------|
| ticker | path | string | 是 | 股票代码 |
| market | query | string | 否 | 市场（A股/港股/美股等），用于路由数据源 |
| data_source | query | string | 否 | 指定数据源（不指定则按市场与优先级自动选） |

**响应**（`data` 为统一股票模型，见 3.1）

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "ticker": "000001",
    "name": "平安银行",
    "market": "SZSE",
    "market_type": "A股",
    "sector": "银行",
    "industry": "股份制银行",
    "currency": "CNY",
    "exchange": "SZSE",
    "country": "China",
    "market_cap": null,
    "pe_ratio": null,
    "listing_date": "1991-04-03T00:00:00",
    "data_source": "akshare"
  }
}
```

未找到或全部数据源失败：`code`: 404 或 503，`data`: null。

#### 2.3.2 股票元信息（批量）

**请求**  
`POST /api/v1/stocks/batch`  
Body: `{ "tickers": ["000001", "600000"], "market": "A股", "data_source": "akshare" }`

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| tickers | string[] | 是 | 股票代码列表 |
| market | string | 否 | 市场 |
| data_source | string | 否 | 指定数据源 |

**响应**  
`data` 为 `{ "<ticker>": { 统一股票模型 } | null }`，缺失或失败的为 null。

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "000001": { "ticker": "000001", "name": "平安银行", "market_type": "A股", ... },
    "600000": null
  }
}
```

#### 2.3.3 股票列表（按市场）

**请求**  
`GET /api/v1/stocks/list?market=A股&data_source=akshare`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| market | string | 是 | 市场 |
| data_source | string | 否 | 指定数据源 |

**响应**  
`data`: `{ "tickers": ["000001", "600000", ... ], "market": "A股", "data_source": "akshare" }`

#### 2.3.4 历史 K 线

**请求**  
`GET /api/v1/kline/{ticker}?period=1d&start_date=2024-01-01&end_date=2024-01-31&market=A股&data_source=akshare`

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ticker | path | 是 | 股票代码 |
| period | query | 否 | 周期，默认 `1d`。见下表 |
| start_date | query | 否 | 开始日期 YYYY-MM-DD |
| end_date | query | 否 | 结束日期 YYYY-MM-DD |
| market | query | 否 | 市场，用于路由 |
| data_source | query | 否 | 指定数据源 |

**period 枚举**：`1m` | `5m` | `15m` | `30m` | `60m` | `1d` | `1w` | `1M`（日线也可接受 `daily`，由服务统一规范为 `1d`）。

**响应**  
`data`: `{ "ticker": "000001", "period": "1d", "data": [ K线条目的数组 ], "data_source": "akshare" }`  
单条 K 线格式见「3.2 统一 K 线模型」。

#### 2.3.5 能力查询（数据源与功能）

对应 §1.3「查询系统支持的数据源与能力」：按 **provider**（数据源接入情况）与 **feature**（功能支持情况）两维度返回。

**请求**  
`GET /api/v1/providers/status`（或 `/api/v1/providers/capabilities`，由实现统一路径）

**响应**  
`data` 需包含：

- **按 provider 维度**：已注册数据源列表、各数据源支持的市场、优先级。
- **按 feature 维度**：各数据源支持的能力（如元信息、列表、K 线等），便于调用方判断「某市场/某能力」由哪些数据源提供。

示例结构：  
`data`: `{ "total_providers": 3, "providers": { "<name>": { "name", "supported_markets", "priority", "features": ["stock_info", "stock_list", "kline"] } }, "market_coverage": { "<market>": ["provider1", "provider2"] }, "feature_coverage": { "stock_info": ["akshare", "yfinance"], "stock_list": ["akshare"], "kline": ["akshare", "yfinance"] } }`

具体字段名与枚举值由实现约定，与本文档能力列表（元信息/列表/K 线）一致即可。

### 2.4 错误码

| code | 含义 | 典型场景 |
|------|------|----------|
| 200 | 成功 | - |
| 400 | 请求参数错误 | 缺少必填、格式错误、period 非法等 |
| 404 | 资源不存在 | 单只股票未找到、无可用数据源等 |
| 429 | 请求过于频繁 | 触发限流 |
| 503 | 服务不可用 | 所有数据源均不可用或超时 |

错误响应中可带 `detail` 或子字段（如 `missing_fields`），由实现约定。

### 2.5 限流策略（设计约定）

- **策略**：可配置「每 IP / 每 API Key」的 QPS 或并发上限；数据源服务自身不实现复杂限流时，可先约定「由网关或上游限流」，并在文档中说明。
- **与外部数据源限流**：各 Provider 内部需遵守外部 API 的限流（如 akshare、yfinance 无官方限流，Tushare/Alpha Vantage 有）；实现时在配置或文档中注明各数据源的限流与退避策略。

---

## 3. 统一数据模型与字段映射

数据源服务作为统一 Proxy，将各 data provider 的原始响应**转换**为下述统一数据模型后返回给调用方；调用方仅依赖本模型，与具体数据源解耦。

### 3.1 统一股票模型（Stock）

供「股票元信息」API 使用；各 Provider 输出必须映射为此模型（缺失字段可为 null）。

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ticker | string | 是 | 股票代码，大写/统一格式 |
| name | string | 是 | 股票名称 |
| market | string | 否 | 市场代码（如 SSE/SZSE/NASDAQ） |
| market_type | string | 否 | 市场类型：A股/港股/美股等 |
| sector | string | 否 | 行业板块 |
| industry | string | 否 | 细分行业 |
| currency | string | 否 | 货币（CNY/USD 等） |
| exchange | string | 否 | 交易所代码 |
| country | string | 否 | 国家/地区 |
| market_cap | number | 否 | 市值 |
| pe_ratio | number | 否 | 市盈率 |
| pb_ratio | number | 否 | 市净率 |
| dividend_yield | number | 否 | 股息率 |
| listing_date | string (ISO 8601) | 否 | 上市日期 |
| data_source | string | 是 | 数据来源标识（如 akshare/yfinance） |

### 3.2 统一 K 线模型（Kline）

单条 K 线（供历史 K 线 API 使用）：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| date | string | 是 | 日期 YYYY-MM-DD |
| timestamp | string | 否 | 时间戳 ISO 8601（分钟线等可用） |
| open | number | 是 | 开盘价 |
| high | number | 是 | 最高价 |
| low | number | 是 | 最低价 |
| close | number | 是 | 收盘价 |
| volume | number | 是 | 成交量 |
| amount | number | 否 | 成交额 |
| adj_close | number | 否 | 复权收盘价 |
| data_source | string | 否 | 数据来源 |

### 3.3 各数据源字段映射说明

实现时，Provider 层在「转发请求 → 取数」之后，将各数据源「原始响应」映射为上述统一模型（即 Proxy 的「转换」环节）。下表为映射关系说明（实现可据此编码）。

#### 3.3.1 股票元信息映射

| 统一字段 | yfinance | akshare (A股) | akshare (港股) | easyquotation | tushare |
|----------|----------|----------------|-----------------|----------------|---------|
| ticker | symbol | code / 代码 | 代码 | 入参 ticker | ts_code 取前缀 |
| name | longName/shortName/name | 股票简称/名称 | 名称 | name | name |
| market | exchange | 由代码推 SSE/SZSE | 交易所 | 固定 A股 | exchange |
| market_type | _determine_market_type(exchange) | A股 | 港股 | A股 | A股 |
| sector | sector | 行业/所属行业 | - | - | industry |
| industry | industry | 同上 | - | - | industry |
| currency | currency | CNY | - | CNY | CNY |
| exchange | exchange | SSE/SZSE | - | - | exchange |
| country | country | China | - | China | China |
| market_cap | marketCap | - | - | - | - |
| pe_ratio | trailingPE/forwardPE | - | - | - | - |
| listing_date | - | list_date/上市日期 | - | - | list_date |
| data_source | "yfinance" | "akshare" | "akshare" | "easyquotation" | "tushare" |

说明：空单元格表示该数据源通常不提供该字段，输出时填 null；实现时需处理中文列名（如 akshare 的「代码」「名称」）。

#### 3.3.2 历史 K 线映射

| 统一字段 | yfinance (history) | akshare (stock_zh_a_hist 等) |
|----------|---------------------|-------------------------------|
| date | index 转 YYYY-MM-DD | 日期 |
| timestamp | index 转 ISO 8601 | 日期转 timestamp |
| open | Open | 开盘 |
| high | High | 最高 |
| low | Low | 最低 |
| close | Close | 收盘 |
| volume | Volume | 成交量 |
| amount | - | 成交额（若有） |
| adj_close | Close（或 Adj Close） | 收盘（复权由 adjust 参数控制） |

实现时需统一 period：如将 `daily` 规范为 `1d`，周/月同理。

---

## 4. Provider 抽象与注册/路由/配置

本节约定数据源服务内部实现：**路由/转发层**负责数据源选择、优先级与容错（§1.2、§1.3）；**Provider 层**负责向外部数据源转发请求、执行字段映射与清洗、输出统一数据模型。每个外部数据源由「Provider」实现统一接口，接口按**能力（feature）**划分，便于部分数据源只实现子集（如 easyquotation 仅行情、无列表），并与 §2.3.5 能力查询（provider/feature）对应。

**元信息能力**（股票信息 + 列表）：

- `name: str` — 数据源唯一标识。
- `supported_markets: List[str]` — 支持的市场（如 `["A股","港股"]`）。
- `priority: int` — 优先级，数字越小越高（如 1=免费优先，2=需 Key）。
- `fetch_stock_info(ticker, market?) -> Optional[统一股票模型]`
- `fetch_stock_list(market?) -> List[str]` — 返回 ticker 列表；不支持则返回空或抛「不支持」。
- `fetch_stock_batch(tickers, market?) -> Dict[ticker, 统一股票模型 | None]` — 可选，未实现则用单只循环。
- `is_available() -> bool` — 健康检查（如探测一次请求是否成功）。

**K 线能力**（可选，与元信息可分离）：

- `fetch_kline(ticker, period, start_date?, end_date?, market?) -> List[统一K线]`
- 若某 Provider 只做元信息不做 K 线，则不实现 K 线接口，由路由层只把「元信息请求」派发给它。

实现时可保留现有 `StockDataProvider` 命名，并扩展 K 线方法；或拆成 `StockMetaProvider` 与 `KlineProvider` 两个接口由同一实现类同时实现。

### 4.2 注册方式

- **显式注册**：启动时从配置读取「已启用」的 Provider 列表，逐个实例化并调用 `router.register(provider)`。
- **约定**：每个 Provider 对应一个唯一 `name`；同一 `name` 重复注册可覆盖或报错，由实现约定。
- **配置驱动**：见「5. 配置」——哪些 Provider 启用、优先级、凭证等均来自配置。

### 4.3 路由与转发规则

路由/转发层将 API 请求**转发**到合适的 Provider（§1.1 转发职责）：

- **按传入数据源**：请求带 `data_source` 时，仅将请求派发到对应 Provider。
- **按市场**：请求带 `market` 时，仅将请求派发到 `supported_markets` 包含该市场的 Provider。
- **按优先级**：同一市场多个 Provider 按 `priority` 排序，先尝试高优先级；若指定 `data_source`，则只调该 Provider（且需支持对应市场）。
- **按能力（feature）**：元信息/列表请求仅派发到实现对应能力的 Provider；K 线请求仅派发到已实现 K 线能力且支持该市场/周期的 Provider；周期与数据源能力映射（如 akshare 的 daily/weekly/monthly）在实现中写死或配置。
- **容错**：某 Provider 失败（异常/超时/返回空）时，按优先级尝试下一个，直到成功或全部失败返回 503/404。

### 4.4 市场与数据源配置矩阵（示例）

| 市场 | 首选 Provider（优先级 1） | 备选（优先级 2） |
|------|---------------------------|------------------|
| A股 | akshare, easyquotation(仅行情) | tushare |
| 港股 | yfinance, akshare | - |
| 美股 | yfinance | iex_cloud, alpha_vantage |

实现时以「配置 + 代码」为准；本文档仅作设计约定。

---

## 5. 配置项清单与环境变量约定

数据源服务负责**凭证与限流配置**（§1.3 职责边界）；所有 Provider 的开关、凭证、限流等均在本服务内集中配置，与「统一 Proxy」单一入口一致。

### 5.1 配置模型（逻辑结构）

- **全局**
  - 服务端口、日志级别等（与现有应用配置一致即可）。
- **按数据源（Provider）**
  - **启用/禁用**：如 `enable_akshare`, `enable_yfinance`, `enable_easyquotation`, `enable_tushare` 等，布尔。
  - **优先级**：可选，默认见 4.4；若配置覆盖则用配置值。
  - **凭证**：如 `tushare_token`, `iex_cloud_api_key`, `alpha_vantage_api_key` 等，字符串；未配置则该 Provider 不注册或标记不可用。
  - **超时/重试**：可选，如请求超时秒数、重试次数；不配置则用默认值。
  - **限流**：可配置「每 IP / 每 API Key」的 QPS 或并发上限；与 2.5 限流策略一致。

### 5.2 环境变量约定（与现有 config 对齐）

建议前缀：`DATA_SOURCE_` 或保留现有 `ENABLE_*` / 各数据源大写命名。示例：

| 环境变量 | 类型 | 默认 | 说明 |
|----------|------|------|------|
| ENABLE_AKSHARE | bool | true | 是否启用 akshare |
| ENABLE_YFINANCE | bool | true | 是否启用 yfinance |
| ENABLE_EASYQUOTATION | bool | false | 是否启用 easyquotation |
| ENABLE_TUSHARE | bool | false | 是否启用 Tushare |
| TUSHARE_TOKEN | string | "" | Tushare token |
| ENABLE_IEX_CLOUD | bool | false | 是否启用 IEX Cloud |
| IEX_CLOUD_API_KEY | string | "" | IEX Cloud API Key |
| ENABLE_ALPHA_VANTAGE | bool | false | 是否启用 Alpha Vantage |
| ALPHA_VANTAGE_API_KEY | string | "" | Alpha Vantage API Key |
| DATA_SOURCE_REQUEST_TIMEOUT | int | 30 | 单次请求超时（秒） |
| DATA_SOURCE_MAX_RETRIES | int | 1 | 失败重试次数 |

校验规则：

- 至少启用一个「第一优先级」数据源（akshare / yfinance / easyquotation 之一）。
- 若某「第二优先级」数据源启用，则对应凭证必填，否则不注册并打 warning。

### 5.3 配置文件示例（可选）

若使用 YAML/JSON 配置，可结构化为：

```yaml
data_sources:
  akshare:
    enabled: true
    priority: 1
  yfinance:
    enabled: true
    priority: 1
  easyquotation:
    enabled: false
    priority: 1
  tushare:
    enabled: false
    priority: 2
    token: ${TUSHARE_TOKEN}
  iex_cloud:
    enabled: false
    priority: 2
    api_key: ${IEX_CLOUD_API_KEY}
```

实现时以项目既有配置方式为准，保持与「5.2 环境变量」一致即可。

---

## 6. 验收标准对照

| 验收项 | 对应章节 |
|--------|----------|
| 设计文档经评审或确认，可作为实现依据 | 全文 |
| 数据源服务作为统一 Proxy，职责边界清晰：只做「转发 → 取数 → 转换 → 返回」，不负责持久化、调度、指标计算 | §1.1, §1.3 |
| 能力查询（按 provider / feature 两维度）可用，调用方可获知当前支持的数据源及能力 | §1.3, §2.2, §2.3.5 |
| API 契约与数据模型覆盖「股票元信息、股票列表、历史 K 线」及能力查询 | §2, §3 |
| 新数据源扩展方式清晰（Provider 接口 + 注册 + 路由 + 配置） | §4, §5 |
| 实现与验证 issue 可据此执行；迁移路径与 1.4 一致 | §1.4, §2–§5 |

---

## 7. 附录：与现有实现的对照表（迁移检查用）

与 §1.4 迁移要点对应；实现时确保数据源服务作为统一 Proxy，上游仅通过本服务获取数据。

| 现有实现 | 设计文档约定 | 迁移时注意 |
|----------|--------------|------------|
| `StockDataProvider`（base.py） | §4.1 Provider 接口（能力维度） | 扩展 K 线方法或拆 KlineProvider；能力与 §2.3.5 能力查询（feature）一致 |
| `fetch_stock_info` / `fetch_all_tickers` / `fetch_multiple_stocks` | 统一为 fetch_stock_info / fetch_stock_list / fetch_stock_batch | 命名与返回值对齐统一模型；仅数据源服务内部调用，对外暴露 §2 契约 |
| `FieldMapper.map_*`（field_mapper.py） | §3.3 字段映射表 | 迁入数据源服务 Provider 层，完成「转换」环节 |
| `HistoricalDataFetcher.fetch_from_yfinance/akshare`、`fetch_kline_data` | §2.3.4 历史 K 线 API + §4.1 K 线能力 | 由数据源服务统一提供 K 线 API，历史数据服务只调该 API，不再直连外部数据源 |
| `StockDataRouter`（router.py） | §4.2–4.3 注册与路由/转发规则 | 保持「市场 + 优先级 + 指定 data_source + 按 feature 派发」逻辑；对应 1.2 路由/转发层 |
| `/api/v1/providers/status` 等 | §2.3.5 能力查询（provider + feature） | 响应扩展为两维度：已注册数据源及支持市场/优先级、各数据源支持的能力（元信息/列表/K 线） |
| `config_validator.validate_data_source_config` | §5.2 校验规则 + §1.3 凭证与限流配置 | 至少一个第一优先级、凭证与启用一致；限流配置归属数据源服务 |
| `initializer.initialize_providers` | §4.2 注册方式 + §5 配置 | 从配置读取启用列表与凭证后注册；与「统一 Proxy」单入口一致 |

---

**文档版本**：1.1  
**最后更新**：按项目维护；与 §1.1–§1.4 统一 Proxy 定位及职责边界一致。
