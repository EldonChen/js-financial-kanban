# 技术路线 - Playground 页面与 BFF 架构设计

> 本文档记录 Playground 页面开发和 BFF 架构 API 层设计的任务拆解和进度跟踪，仅用于当前任务。

## 任务概述

1. **Playground 页面开发**：在新的前端项目中，增加一个 playground 页面，用于访问和测试三个后端服务（Node.js、Python、Rust）
2. **BFF 架构 API 层设计**：设计新的 API 层，支持当前直接调用后端服务，后续平滑过渡到 BFF 架构

## 任务状态说明

- ✅ **已完成**：任务已完成
- 🚧 **进行中**：任务正在进行
- ⏸️ **阻塞中**：任务遇到阻塞，需要解决
- ⏳ **待开始**：任务尚未开始
- ❌ **已取消**：任务已取消

## 任务拆解

### Phase 1：API 层基础架构（核心）

#### 1.1 设计适配器接口和类型定义 ✅ 已完成
- **任务描述**：设计统一的适配器接口和 API 类型定义
- **完成标准**：
  - 创建 `app/api/types.ts`，定义统一的类型：
    - `ApiResponse<T>`：统一响应格式
    - `ApiError`：错误类型
    - `RequestConfig`：请求配置
    - `Item`、`CreateItemDto`、`UpdateItemDto`：数据模型
  - 创建 `app/api/adapters/index.ts`，定义 `ApiAdapter` 接口：
    - `get<T>(url, config?)`：GET 请求
    - `post<T>(url, data?, config?)`：POST 请求
    - `put<T>(url, data?, config?)`：PUT 请求
    - `delete<T>(url, config?)`：DELETE 请求
  - 所有类型都有完整的 TypeScript 类型定义
- **依赖关系**：无
- **注意事项**：
  - 类型定义要考虑三个后端服务的差异
  - 适配器接口要支持后续 BFF 切换
  - 使用 TypeScript 严格模式

#### 1.2 实现 DirectAdapter（直接调用后端） ✅ 已完成
- **任务描述**：实现直接调用后端服务的适配器
- **完成标准**：
  - 创建 `app/api/adapters/direct.ts`
  - 实现 `DirectAdapter` 类，实现 `ApiAdapter` 接口
  - 使用 Fetch API 发送请求
  - 处理统一的响应格式 `{ code, message, data }`
  - 处理错误响应和网络错误
  - 支持请求配置（headers、timeout 等）
  - 添加请求日志（可选）
- **依赖关系**：1.1
- **注意事项**：
  - 确保错误处理正确
  - 支持跨域请求
  - 处理网络超时
  - 统一错误格式

#### 1.3 创建统一 ApiClient ✅ 已完成
- **任务描述**：创建统一的 API 客户端，支持切换适配器
- **完成标准**：
  - 创建 `app/api/client.ts`
  - 实现 `ApiClient` 类：
    - 支持依赖注入，通过构造函数注入适配器
    - 默认使用 `DirectAdapter`
    - 提供统一的 API 调用方法（get、post、put、delete）
    - 支持请求/响应拦截器（预留接口）
    - 统一的错误处理
  - 支持通过配置切换适配器
  - 导出单例实例（可选）
- **依赖关系**：1.2
- **注意事项**：
  - 使用依赖注入模式，便于测试
  - 预留拦截器接口，便于后续扩展
  - 确保类型安全

#### 1.4 实现服务层封装 - Node.js 服务 ✅ 已完成
- **任务描述**：封装 Node.js 服务的 API 调用
- **完成标准**：
  - 创建 `app/api/services/node.ts`
  - 定义 Node.js 服务的数据类型：
    - `NodeItem`：Item 类型（使用 `_id` 字段）
    - `CreateNodeItemDto`：创建 DTO
    - `UpdateNodeItemDto`：更新 DTO
  - 实现 CRUD 方法：
    - `getItems()`：获取所有 items
    - `getItem(id)`：获取单个 item
    - `createItem(data)`：创建 item
    - `updateItem(id, data)`：更新 item
    - `deleteItem(id)`：删除 item
  - 使用 `ApiClient` 进行 API 调用
  - 处理数据转换（`_id` → `id`，如果需要）
  - 添加错误处理
- **依赖关系**：1.3
- **注意事项**：
  - 确保 API 路径正确（`/api/v1/items`）
  - 处理 Node.js 服务的响应格式
  - 类型定义要准确

#### 1.5 实现服务层封装 - Python 服务 ✅ 已完成
- **任务描述**：封装 Python 服务的 API 调用
- **完成标准**：
  - 创建 `app/api/services/python.ts`
  - 定义 Python 服务的数据类型：
    - `PythonItem`：Item 类型（使用 `id` 字段）
    - `CreatePythonItemDto`：创建 DTO
    - `UpdatePythonItemDto`：更新 DTO
  - 实现 CRUD 方法（同 1.4）
  - 使用 `ApiClient` 进行 API 调用
  - 处理数据转换（`created_at` → `createdAt`，如果需要）
  - 添加错误处理
- **依赖关系**：1.3
- **注意事项**：
  - Python 服务使用 `id` 字段（不是 `_id`）
  - 字段命名可能使用下划线（`created_at`）
  - 确保 API 路径正确

#### 1.6 实现服务层封装 - Rust 服务 ✅ 已完成
- **任务描述**：封装 Rust 服务的 API 调用
- **完成标准**：
  - 创建 `app/api/services/rust.ts`
  - 定义 Rust 服务的数据类型：
    - `RustItem`：Item 类型（使用 `id` 字段）
    - `CreateRustItemDto`：创建 DTO
    - `UpdateRustItemDto`：更新 DTO
  - 实现 CRUD 方法（同 1.4）
  - 使用 `ApiClient` 进行 API 调用
  - 处理数据转换（如果需要）
  - 添加错误处理
- **依赖关系**：1.3
- **注意事项**：
  - Rust 服务使用 `id` 字段（不是 `_id`）
  - 字段命名可能使用下划线（`created_at`）
  - 确保 API 路径正确

#### 1.7 配置环境变量和 Runtime Config ✅ 已完成
- **任务描述**：配置环境变量和 Nuxt Runtime Config
- **完成标准**：
  - 创建 `.env.example` 文件，包含：
    - `NUXT_PUBLIC_NODE_API_URL=http://localhost:3000`
    - `NUXT_PUBLIC_PYTHON_API_URL=http://localhost:8000`
    - `NUXT_PUBLIC_RUST_API_URL=http://localhost:8080`
    - `NUXT_PUBLIC_BFF_API_URL=http://localhost:4000`（预留）
  - 更新 `nuxt.config.ts`，添加 `runtimeConfig`：
    - 配置三个后端服务的 URL
    - 预留 BFF 服务 URL
  - 在适配器和服务层使用 Runtime Config
- **依赖关系**：1.2, 1.4, 1.5, 1.6
- **注意事项**：
  - 使用 `useRuntimeConfig()` 获取配置
  - 确保配置类型正确
  - 提供默认值

### Phase 2：Playground 页面开发（核心）

#### 2.1 创建 Playground 主页面（服务选择） ✅ 已完成
- **任务描述**：创建 Playground 主页面，展示三个服务的卡片
- **完成标准**：
  - 创建 `app/pages/playground/index.vue`
  - 使用 Card 组件展示三个服务：
    - Node.js 服务卡片
    - Python 服务卡片
    - Rust 服务卡片
  - 每个卡片包含：
    - 服务名称和图标
    - 服务描述
    - 进入按钮（跳转到对应服务页面）
  - 使用响应式布局（Grid）
  - 添加页面标题和描述
- **依赖关系**：无（可并行进行）
- **注意事项**：
  - 使用 Shadcn Vue 的 Card 组件
  - 保持设计简洁美观
  - 响应式设计，支持移动端

#### 2.2 创建服务测试页面 - Node.js ✅ 已完成
- **任务描述**：创建 Node.js 服务的测试页面
- **完成标准**：
  - 创建 `app/pages/playground/node.vue`
  - 实现数据列表展示：
    - 使用 Table 组件展示 items 列表
    - 显示 id、name、description、price 等字段
    - 添加加载状态（Skeleton）
    - 添加空状态提示
  - 实现 CRUD 操作：
    - **创建**：Dialog/Sheet 表单，包含 name、description、price 字段
    - **更新**：Dialog/Sheet 表单，预填充数据
    - **删除**：确认对话框，删除后刷新列表
  - 使用 Toast/Sonner 显示操作结果
  - 添加错误处理，显示错误信息
- **依赖关系**：1.4, 2.1
- **注意事项**：
  - 使用 `api/services/node.ts` 进行 API 调用
  - 处理加载状态和错误状态
  - 表单验证（可选）
  - 用户体验优化

#### 2.3 创建服务测试页面 - Python ✅ 已完成
- **任务描述**：创建 Python 服务的测试页面
- **完成标准**：
  - 创建 `app/pages/playground/python.vue`
  - 实现功能同 2.2（列表展示、CRUD 操作）
  - 使用 `api/services/python.ts` 进行 API 调用
- **依赖关系**：1.5, 2.1
- **注意事项**：
  - 与 Node.js 页面保持一致的 UI 和交互
  - 处理 Python 服务的数据格式差异

#### 2.4 创建服务测试页面 - Rust ✅ 已完成
- **任务描述**：创建 Rust 服务的测试页面
- **完成标准**：
  - 创建 `app/pages/playground/rust.vue`
  - 实现功能同 2.2（列表展示、CRUD 操作）
  - 使用 `api/services/rust.ts` 进行 API 调用
- **依赖关系**：1.6, 2.1
- **注意事项**：
  - 与 Node.js 页面保持一致的 UI 和交互
  - 处理 Rust 服务的数据格式差异

#### 2.5 更新导航菜单配置 ✅ 已完成
- **任务描述**：在导航菜单中添加 Playground 入口
- **完成标准**：
  - 更新 `app/constants/menus.ts`（如果存在）
  - 或创建新的菜单配置
  - 添加 Playground 菜单项：
    - 主菜单项：Playground
    - 子菜单项：Node.js、Python、Rust
  - 确保侧边栏导航正常显示
  - 路由高亮正常
- **依赖关系**：2.1, 2.2, 2.3, 2.4
- **注意事项**：
  - 菜单配置要与路由结构一致
  - 使用合适的图标
  - 保持菜单结构清晰

### Phase 3：功能完善（重要）

#### 3.1 添加请求/响应拦截器（预留） ✅ 已完成
- **任务描述**：在 ApiClient 中添加拦截器机制
- **完成标准**：
  - 在 `ApiClient` 中添加拦截器接口：
    - `requestInterceptor`：请求拦截器
    - `responseInterceptor`：响应拦截器
  - 支持多个拦截器（数组）
  - 拦截器执行顺序正确
  - 预留认证拦截器接口（添加 token 等）
  - 预留日志拦截器接口
- **依赖关系**：1.3
- **注意事项**：
  - 拦截器要支持异步操作
  - 确保拦截器不会影响现有功能
  - 提供清晰的拦截器使用示例

#### 3.2 完善错误处理 ⏳ 待开始
- **任务描述**：完善统一的错误处理机制
- **完成标准**：
  - 创建 `app/api/utils.ts`，添加错误处理工具函数
  - 统一错误格式转换
  - 提供错误类型判断（网络错误、业务错误、服务器错误等）
  - 在页面中统一显示错误信息
  - 创建 `app/composables/useApiError.ts`（可选）
- **依赖关系**：1.3
- **注意事项**：
  - 错误信息要清晰易懂
  - 区分不同类型的错误
  - 提供错误恢复建议（可选）

#### 3.3 优化用户体验 ⏳ 待开始
- **任务描述**：优化 Playground 页面的用户体验
- **完成标准**：
  - 添加页面加载动画
  - 优化表单交互（实时验证、错误提示）
  - 添加操作确认（删除确认等）
  - 优化响应式布局
  - 添加键盘快捷键（可选）
- **依赖关系**：2.2, 2.3, 2.4
- **注意事项**：
  - 保持交互简洁
  - 避免过度动画
  - 确保性能不受影响

### Phase 4：BFF 准备（后续）

#### 4.1 预留 BffAdapter 接口 ✅ 已完成
- **任务描述**：预留 BFF 适配器接口，不实现具体逻辑
- **完成标准**：
  - 创建 `app/api/adapters/bff.ts`
  - 定义 `BffAdapter` 类，实现 `ApiAdapter` 接口
  - 实现占位方法（返回错误或提示）
  - 添加 TODO 注释说明后续实现
  - 添加 BFF API 路径前缀配置
- **依赖关系**：1.1
- **注意事项**：
  - 接口要与 `DirectAdapter` 保持一致
  - 添加清晰的注释说明
  - 不实现具体逻辑，只预留接口

#### 4.2 设计 BFF API 规范（文档） ✅ 已完成
- **任务描述**：设计 BFF API 规范文档
- **完成标准**：
  - 创建 `docs/BFF-API-规范.md` 文档
  - 定义 BFF API 路径规范（如 `/api/bff/items`）
  - 定义统一的请求/响应格式
  - 说明如何从 DirectAdapter 切换到 BffAdapter
  - 提供 BFF 服务实现建议
- **依赖关系**：4.1
- **注意事项**：
  - 文档要清晰易懂
  - 包含代码示例
  - 说明迁移步骤

### Phase 5：测试和验证（重要）

#### 5.1 功能测试 ⏳ 待开始
- **任务描述**：测试所有功能是否正常工作
- **完成标准**：
  - 测试三个服务的 CRUD 操作
  - 测试错误处理（网络错误、业务错误等）
  - 测试加载状态显示
  - 测试响应式布局
  - 测试导航菜单
- **依赖关系**：2.5, 3.3
- **注意事项**：
  - 确保所有功能正常工作
  - 记录发现的问题
  - 修复发现的问题

#### 5.2 代码质量检查 ⏳ 待开始
- **任务描述**：进行代码质量检查
- **完成标准**：
  - 代码编译通过
  - 无 TypeScript 错误
  - 无 ESLint 错误
  - 所有功能正常工作
  - 代码符合项目规范
- **依赖关系**：5.1
- **注意事项**：
  - 这是强制检查点
  - 必须通过才能继续
  - 修复所有问题

## 任务依赖关系图

```
Phase 1: API 层基础架构
1.1 → 1.2 → 1.3 → 1.4
                  → 1.5
                  → 1.6
1.2, 1.4, 1.5, 1.6 → 1.7

Phase 2: Playground 页面开发
2.1 (独立)
1.4 → 2.2
1.5 → 2.3
1.6 → 2.4
2.1, 2.2, 2.3, 2.4 → 2.5

Phase 3: 功能完善
1.3 → 3.1
1.3 → 3.2
2.2, 2.3, 2.4 → 3.3

Phase 4: BFF 准备
1.1 → 4.1 → 4.2

Phase 5: 测试和验证
2.5, 3.3 → 5.1 → 5.2
```

## 检查清单

### 开发前检查
- [ ] 已理解技术方案设计
- [ ] 已确认技术选型
- [ ] 已了解三个后端服务的 API 格式

### Phase 1 检查
- [ ] 适配器接口已设计
- [ ] DirectAdapter 已实现
- [ ] ApiClient 已创建
- [ ] 三个服务的 API 封装已完成
- [ ] 环境变量和 Runtime Config 已配置

### Phase 2 检查
- [ ] Playground 主页面已创建
- [ ] 三个服务的测试页面已创建
- [ ] CRUD 操作功能正常
- [ ] 导航菜单已更新
- [ ] 所有页面功能正常

### Phase 3 检查
- [ ] 拦截器机制已添加（预留）
- [ ] 错误处理已完善
- [ ] 用户体验已优化

### Phase 4 检查
- [ ] BffAdapter 接口已预留
- [ ] BFF API 规范文档已创建

### Phase 5 检查
- [ ] 功能测试已通过
- [ ] 代码质量检查已通过
- [ ] 所有功能正常工作

## 注意事项

1. **Keep it Simple**：优先实现核心功能，避免过度设计
2. **类型安全**：确保所有 API 调用都有完整的类型定义
3. **错误处理**：统一的错误处理机制，提供清晰的错误信息
4. **向后兼容**：确保现有功能在重构后仍能正常工作
5. **代码质量**：每个阶段完成后进行代码质量检查
6. **文档更新**：及时更新文档，保持与代码同步
7. **测试验证**：每个功能完成后进行测试验证

## 后续工作（不在本次任务范围）

1. **BFF 服务实现**：创建实际的 BFF 服务
2. **认证系统**：添加认证和授权功能
3. **缓存机制**：添加请求缓存，提升性能
4. **请求重试**：添加自动重试机制
5. **监控和日志**：添加请求监控和日志记录
6. **单元测试和 E2E 测试**：添加自动化测试

---

**创建时间**：2024年
**文档版本**：v1.0
**适用任务**：Playground 页面开发 + BFF 架构设计
