# 技术路线 - BFF 层设计与实现

> 本文档仅用于 BFF 层设计与实现任务，任务完成后可归档或删除。

## 任务概述

设计并实现 BFF（Backend For Frontend）层，为前端提供定制化、高聚合度的接口。

## 任务拆解

### 阶段1：项目结构与基础配置（✅ 已完成）

#### 1.1 创建 BFF 目录结构
- [x] 创建 `bff/` 目录
- [x] 创建 `bff/bff-main/` 主 BFF 服务目录
- [x] 创建基础目录结构（src/views, src/clients, src/common）
- [x] 创建 `bff/shared/` 共享代码目录（可选）

**状态**：✅ 已完成  
**依赖**：无  
**预计耗时**：15 分钟

#### 1.2 初始化 NestJS 项目
- [x] 在 `bff/bff-main/` 目录初始化 NestJS 项目
- [x] 配置 TypeScript
- [x] 配置 ESLint 和 Prettier
- [x] 创建基础模块结构

**状态**：✅ 已完成  
**依赖**：1.1  
**预计耗时**：30 分钟

#### 1.3 配置 Monorepo（pnpm workspace）
- [x] 在根目录创建或更新 `pnpm-workspace.yaml`
- [x] 在根目录 `package.json` 配置 workspace
- [x] 配置 BFF 项目的 `package.json`
- [ ] 测试 workspace 依赖安装（待用户测试）

**状态**：✅ 已完成  
**依赖**：1.2  
**预计耗时**：20 分钟

#### 1.4 配置环境变量
- [x] 创建 `bff/bff-main/.env.example`
- [x] 配置后台服务 URL（Python、Node、Rust、股票服务）
- [x] 配置 BFF 服务端口
- [x] 配置 MongoDB 连接（如果需要）

**状态**：✅ 已完成  
**依赖**：1.2  
**预计耗时**：15 分钟

### 阶段2：公共模块与基础设施（✅ 已完成）

#### 2.1 创建 HTTP 客户端模块
- [x] 安装 `@nestjs/axios` 或使用 `@nestjs/fetch`
- [x] 创建 `clients/` 模块
- [x] 实现 Python 服务客户端（`python.client.ts`）
- [x] 实现 Node 服务客户端（`node.client.ts`）
- [x] 实现 Rust 服务客户端（`rust.client.ts`）
- [x] 实现股票服务客户端（`stock-info.client.ts`）
- [x] 配置超时和重试策略

**状态**：✅ 已完成  
**依赖**：1.4  
**预计耗时**：1.5 小时

#### 2.2 创建统一响应格式
- [x] 创建响应 DTO（`common/dto/response.dto.ts`）
- [x] 创建响应拦截器（`common/interceptors/transform.interceptor.ts`）
- [x] 配置全局拦截器

**状态**：✅ 已完成  
**依赖**：1.2  
**预计耗时**：30 分钟

#### 2.3 创建错误处理
- [x] 创建异常过滤器（`common/filters/http-exception.filter.ts`）
- [x] 创建自定义异常类
- [x] 配置全局异常过滤器

**状态**：✅ 已完成  
**依赖**：1.2  
**预计耗时**：30 分钟

#### 2.4 创建工具函数
- [x] 创建数据转换工具（`common/utils/transform.util.ts`）
- [x] 创建并发控制工具（`common/utils/promise.util.ts`）
- [ ] 创建缓存工具（可选，`common/utils/cache.util.ts`）- 暂未实现

**状态**：✅ 已完成  
**依赖**：1.2  
**预计耗时**：45 分钟

### 阶段3：视图模块实现（✅ 已完成）

#### 3.1 创建 Dashboard 视图模块
- [x] 创建 `views/dashboard/` 模块
- [x] 实现 Dashboard Controller
- [x] 实现 Dashboard Service
- [x] 聚合多个服务的数据（如：统计信息、最新数据等）
- [x] 创建 Dashboard DTO/VO

**状态**：✅ 已完成  
**依赖**：2.1, 2.2  
**预计耗时**：1 小时

#### 3.2 创建 Items 视图模块
- [x] 创建 `views/items/` 模块
- [x] 实现 Items Controller
- [x] 实现 Items Service
- [x] 聚合 Python/Node/Rust 三个服务的 Items 数据
- [x] 实现数据合并、去重、排序逻辑
- [x] 创建 Items DTO/VO

**状态**：✅ 已完成  
**依赖**：2.1, 2.2  
**预计耗时**：1.5 小时

#### 3.3 创建 Stocks 视图模块
- [x] 创建 `views/stocks/` 模块
- [x] 实现 Stocks Controller
- [x] 实现 Stocks Service
- [x] 聚合股票信息服务的数据
- [x] 实现数据转换和格式化
- [x] 创建 Stocks DTO/VO

**状态**：✅ 已完成  
**依赖**：2.1, 2.2  
**预计耗时**：1 小时

### 阶段4：性能优化与错误处理（待开始）

#### 4.1 实现并发调用优化
- [ ] 在 Service 中使用 `Promise.all()` 并行调用
- [ ] 实现超时控制
- [ ] 实现请求去重（可选）

**状态**：待开始  
**依赖**：3.1, 3.2, 3.3  
**预计耗时**：45 分钟

#### 4.2 实现部分失败处理
- [ ] 使用 `Promise.allSettled()` 处理部分失败
- [ ] 实现降级策略（使用默认值或缓存）
- [ ] 记录错误日志

**状态**：待开始  
**依赖**：3.1, 3.2, 3.3  
**预计耗时**：45 分钟

#### 4.3 实现缓存策略（可选）
- [ ] 配置 Redis 或内存缓存
- [ ] 在 Service 中实现缓存逻辑
- [ ] 设置缓存过期时间

**状态**：待开始  
**依赖**：3.1, 3.2, 3.3  
**预计耗时**：1 小时

### 阶段5：Docker 集成（✅ 已完成）

#### 5.1 创建 Dockerfile
- [x] 创建 `bff/bff-main/Dockerfile`
- [x] 使用多阶段构建
- [x] 配置 Bun 运行时
- [x] 优化镜像大小

**状态**：✅ 已完成  
**依赖**：阶段1-4  
**预计耗时**：30 分钟

#### 5.2 创建 .dockerignore
- [x] 创建 `bff/bff-main/.dockerignore`
- [x] 排除不必要的文件

**状态**：✅ 已完成  
**依赖**：5.1  
**预计耗时**：10 分钟

#### 5.3 集成到 docker-compose.yml
- [x] 在根目录 `docker-compose.yml` 添加 `bff-main` 服务
- [x] 配置服务依赖
- [x] 配置网络和端口映射
- [x] 配置健康检查
- [x] 配置环境变量

**状态**：✅ 已完成  
**依赖**：5.1  
**预计耗时**：20 分钟

### 阶段6：测试与文档（待开始）

#### 6.1 单元测试
- [ ] 为 HTTP 客户端编写单元测试
- [ ] 为 Service 编写单元测试
- [ ] 为工具函数编写单元测试
- [ ] 使用 Mock 模拟后台服务

**状态**：待开始  
**依赖**：阶段2-4  
**预计耗时**：2 小时

#### 6.2 集成测试
- [ ] 创建集成测试配置
- [ ] 编写集成测试（需要后台服务运行）
- [ ] 测试数据聚合逻辑
- [ ] 测试错误处理

**状态**：待开始  
**依赖**：阶段2-4  
**预计耗时**：1.5 小时

#### 6.3 更新文档
- [x] 创建 `bff/bff-main/README.md`
- [ ] 更新根目录 `README.md`，添加 BFF 层说明（待完成）
- [ ] 更新 API 文档（Swagger/OpenAPI）（可选）
- [ ] 更新 `changelog.md`（待完成）

**状态**：🔄 进行中  
**依赖**：阶段1-5  
**预计耗时**：45 分钟

### 阶段7：前端集成（待开始）

#### 7.1 创建前端 BFF API 封装
- [ ] 创建 `frontend/api/bff.ts`
- [ ] 封装 BFF 接口调用
- [ ] 定义 TypeScript 类型

**状态**：待开始  
**依赖**：阶段3  
**预计耗时**：30 分钟

#### 7.2 更新前端页面
- [ ] 更新 `pages/index.vue`，使用 BFF 接口
- [ ] 更新 `pages/items.vue`（如果有），使用 BFF 接口
- [ ] 更新 `pages/stocks.vue`（如果有），使用 BFF 接口
- [ ] 移除直接调用后台服务的代码

**状态**：待开始  
**依赖**：7.1  
**预计耗时**：1 小时

#### 7.3 更新前端环境变量
- [ ] 更新 `frontend/.env.example`
- [ ] 添加 BFF API URL 配置
- [ ] 更新 `nuxt.config.ts` 配置

**状态**：待开始  
**依赖**：7.1  
**预计耗时**：15 分钟

## 任务依赖关系图

```
阶段1（项目结构）
  ↓
阶段2（公共模块）
  ↓
阶段3（视图模块）← 阶段4（性能优化）
  ↓
阶段5（Docker 集成）
  ↓
阶段6（测试与文档）
  ↓
阶段7（前端集成）
```

## 注意事项

1. **代码质量**：每个阶段完成后进行代码质量检查
2. **测试覆盖**：确保关键逻辑有单元测试和集成测试
3. **错误处理**：确保所有错误情况都有处理
4. **性能考虑**：注意并发调用和超时控制
5. **类型安全**：使用 TypeScript 确保类型安全
6. **文档同步**：及时更新相关文档

## 检查清单

### 阶段1 完成检查
- [ ] BFF 目录结构已创建
- [ ] NestJS 项目已初始化
- [ ] pnpm workspace 已配置
- [ ] 环境变量已配置

### 阶段2 完成检查
- [ ] HTTP 客户端已实现
- [ ] 统一响应格式已配置
- [ ] 错误处理已实现
- [ ] 工具函数已创建

### 阶段3 完成检查
- [ ] Dashboard 视图已实现
- [ ] Items 视图已实现
- [ ] Stocks 视图已实现
- [ ] 所有接口可正常访问

### 阶段4 完成检查
- [ ] 并发调用已优化
- [ ] 部分失败处理已实现
- [ ] 缓存策略已实现（如果采用）

### 阶段5 完成检查
- [ ] Dockerfile 已创建
- [ ] docker-compose.yml 已更新
- [ ] 服务可正常启动

### 阶段6 完成检查
- [ ] 单元测试已编写并通过
- [ ] 集成测试已编写并通过
- [ ] 文档已更新

### 阶段7 完成检查
- [ ] 前端 API 封装已创建
- [ ] 前端页面已更新
- [ ] 前端可正常调用 BFF 接口

---

**文档版本**：v1.0  
**创建时间**：2024年  
**最后更新**：2024年
