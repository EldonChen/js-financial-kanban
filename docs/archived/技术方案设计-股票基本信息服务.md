# ✅ 已完结 - 技术方案设计 - 股票基本信息服务

> **项目状态**：已完成并归档  
> **完成时间**：2024年  
> **归档位置**：docs/archived/

## 项目概述

新增一个独立的股票基本信息服务（py-stock-info-service），基于 Python + FastAPI + yfinance，用于从 Yahoo Finance 抓取股票信息，经过数据转换后存入 MongoDB，并提供 RESTful API 接口供其他服务调用。

## 项目技术关键点

### 1. 技术栈选型

#### 核心技术
- **框架**: FastAPI（与现有 python-service 保持一致）
- **数据抓取**: yfinance（Yahoo Finance 官方 Python 库）
- **数据库**: MongoDB（与项目其他服务共享数据库）
- **数据库驱动**: Motor（异步 MongoDB 驱动）
- **定时任务**: APScheduler（支持异步任务调度）
- **数据验证**: Pydantic 2.x
- **包管理**: uv（与现有 python-service 保持一致）

#### 技术选型理由
1. **yfinance**: 
   - 官方维护的 Yahoo Finance Python 库
   - 支持获取股票基本信息、历史价格、财务数据等
   - API 简单易用，文档完善
   - 支持多股票批量查询

2. **APScheduler**:
   - 支持异步任务调度（AsyncIOScheduler）
   - 支持 Cron 表达式和间隔调度
   - 可以持久化任务到数据库（可选）
   - 与 FastAPI 集成简单

3. **FastAPI**:
   - 与现有 python-service 保持一致的技术栈
   - 异步支持良好，适合 I/O 密集型任务
   - 自动生成 API 文档

## 架构设计决策

### 1. 服务结构设计

```
py-stock-info-service/
├── app/
│   ├── __init__.py
│   ├── main.py              # 应用入口，集成 APScheduler
│   ├── config.py            # 配置管理
│   ├── database.py          # MongoDB 连接
│   ├── routers/             # 路由模块
│   │   ├── __init__.py
│   │   ├── stocks.py        # 股票查询接口
│   │   └── schedules.py     # 更新计划管理接口
│   ├── schemas/             # Pydantic 模式
│   │   ├── __init__.py
│   │   ├── stock.py         # 股票数据模式
│   │   ├── schedule.py      # 更新计划模式
│   │   └── response.py      # 统一响应格式
│   ├── services/            # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── yfinance_service.py  # yfinance 数据抓取服务
│   │   ├── stock_service.py    # 股票数据业务逻辑
│   │   └── scheduler_service.py # 定时任务服务
│   └── models/              # 数据模型（MongoDB 集合定义）
│       ├── __init__.py
│       ├── stock.py         # 股票数据模型
│       └── schedule.py      # 更新计划模型
├── tests/                   # 测试代码
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_stocks.py
│   └── test_schedules.py
├── .env.example
├── pyproject.toml
├── pytest.ini
├── Dockerfile
├── .dockerignore
└── README.md
```

### 2. 数据模型设计

#### 2.1 股票基本信息集合（stocks）

```python
{
  "_id": ObjectId,
  "ticker": "AAPL",              # 股票代码（唯一标识）
  "name": "Apple Inc.",          # 股票名称
  "market": "NASDAQ",            # 市场（NASDAQ, NYSE, 等）
  "sector": "Technology",         # 行业板块
  "industry": "Consumer Electronics",  # 细分行业
  "currency": "USD",             # 货币
  "exchange": "NMS",             # 交易所代码
  "country": "United States",    # 国家
  "data_source": "yfinance",     # 数据来源
  "last_updated": ISODate,       # 最后更新时间
  "created_at": ISODate,         # 创建时间
  "updated_at": ISODate          # 更新时间
}
```

**索引设计**:
- `ticker`: 唯一索引
- `name`: 文本索引（支持模糊查询）
- `market`: 普通索引
- `ticker + market`: 复合索引（用于精确查询）

#### 2.2 更新计划集合（update_schedules）

```python
{
  "_id": ObjectId,
  "schedule_type": "cron",       # 调度类型：cron 或 interval
  "schedule_config": {           # 调度配置
    "cron": "0 9 * * 1-5",       # Cron 表达式（工作日 9:00）
    # 或
    "interval": 3600             # 间隔秒数
  },
  "is_active": true,             # 是否激活
  "last_run": ISODate,           # 最后执行时间
  "next_run": ISODate,           # 下次执行时间
  "run_count": 100,              # 执行次数
  "error_count": 2,              # 错误次数
  "last_error": "Connection timeout",  # 最后错误信息
  "created_at": ISODate,
  "updated_at": ISODate
}
```

**索引设计**:
- `is_active`: 普通索引
- `next_run`: 普通索引（用于查询待执行任务）

### 3. API 接口设计

#### 3.1 股票查询接口（读接口）

**GET /api/v1/stocks**
- 功能：根据条件筛选股票列表
- 查询参数：
  - `ticker`: 股票代码（精确匹配）
  - `name`: 股票名称（模糊查询，支持部分匹配）
  - `market`: 市场（精确匹配）
  - `sector`: 行业板块（精确匹配）
  - `page`: 页码（默认 1）
  - `page_size`: 每页数量（默认 20，最大 100）
- 响应：分页的股票列表

**GET /api/v1/stocks/{ticker}**
- 功能：获取单个股票的详细信息
- 路径参数：`ticker` - 股票代码
- 响应：股票详细信息

#### 3.2 更新计划查询接口（读接口）

**GET /api/v1/schedules**
- 功能：查询所有更新计划
- 查询参数：
  - `is_active`: 是否激活（可选，true/false）
  - `page`: 页码
  - `page_size`: 每页数量
- 响应：分页的更新计划列表

**GET /api/v1/schedules/{schedule_id}**
- 功能：获取单个更新计划的详细信息
- 响应：更新计划详细信息

**GET /api/v1/schedules/status**
- 功能：查询更新状态统计
- 响应：统计信息（总计划数、激活数、待执行数等）

#### 3.3 更新计划管理接口（写接口）

**POST /api/v1/schedules**
- 功能：新增更新计划
- 请求体：
  ```json
  {
    "schedule_type": "cron",
    "schedule_config": {
      "cron": "0 9 * * 1-5"
    }
  }
  ```
- 响应：创建的更新计划

**PUT /api/v1/schedules/{schedule_id}**
- 功能：更新更新计划（修改调度配置、激活状态等）
- 请求体：部分字段更新

**DELETE /api/v1/schedules/{schedule_id}**
- 功能：取消/删除更新计划
- 响应：删除成功信息

**POST /api/v1/schedules/{schedule_id}/toggle**
- 功能：切换更新计划的激活状态
- 响应：更新后的计划信息

#### 3.4 手动执行更新接口（写接口）

**POST /api/v1/stocks/{ticker}/update**
- 功能：手动触发单个股票的更新
- 路径参数：`ticker` - 股票代码
- 响应：更新结果（成功/失败，更新后的数据）

**POST /api/v1/stocks/update-all**
- 功能：手动触发所有股票的更新
- 响应：更新结果（成功/失败，更新后的数据）

**POST /api/v1/stocks/batch-update**
- 功能：批量手动更新股票
- 请求体：
  ```json
  {
    "tickers": ["AAPL", "GOOGL", "MSFT"]
  }
  ```
- 响应：批量更新结果

### 4. 数据抓取与转换流程

#### 4.1 yfinance 数据抓取

使用 yfinance 获取股票信息：

```python
import yfinance as yf

ticker = yf.Ticker("AAPL")
info = ticker.info  # 获取股票基本信息
```

**抓取的数据字段映射**:
- `symbol` → `ticker`
- `longName` 或 `shortName` → `name`
- `exchange` → `market`
- `sector` → `sector`
- `industry` → `industry`
- `currency` → `currency`
- `exchange` → `exchange`
- `country` → `country`

#### 4.2 数据转换与存储

1. **数据清洗**：
   - 处理缺失字段（使用默认值或 None）
   - 数据类型转换（确保类型一致）
   - 字符串规范化（去除多余空格、统一大小写等）

2. **数据存储**：
   - 使用 `upsert` 操作（根据 ticker 更新或插入）
   - 更新 `last_updated` 和 `updated_at` 字段
   - 如果是新股票，设置 `created_at`

### 5. 定时任务设计

#### 5.1 APScheduler 集成

在 FastAPI 应用启动时初始化 APScheduler：

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

scheduler = AsyncIOScheduler()

# 应用启动时启动调度器
scheduler.start()

# 应用关闭时关闭调度器
scheduler.shutdown()
```

#### 5.2 任务执行流程

1. **任务注册**：
   - 从 MongoDB 读取所有激活的更新计划
   - 为每个计划注册 APScheduler 任务
   - 任务函数调用股票数据更新服务

2. **任务执行**：
   - 调用 yfinance 抓取数据
   - 数据转换和清洗
   - 更新 MongoDB
   - 更新计划的执行记录（`last_run`, `run_count`, `error_count`）

3. **错误处理**：
   - 捕获异常并记录错误信息
   - 更新计划的 `error_count` 和 `last_error`
   - 不中断其他任务的执行

#### 5.3 动态任务管理

- **新增计划**：立即注册到 APScheduler
- **更新计划**：移除旧任务，注册新任务
- **取消计划**：从 APScheduler 移除任务
- **切换激活状态**：动态添加/移除任务

## 技术难点与解决方案

### 1. yfinance 数据字段不一致

**问题**：不同股票可能返回不同的字段，某些字段可能缺失。

**解决方案**：
- 使用 Pydantic 模型定义必需字段和可选字段
- 数据转换时使用 `get()` 方法安全获取字段
- 为缺失字段设置合理的默认值
- 记录数据质量日志，便于排查问题

### 2. 定时任务的持久化

**问题**：服务重启后，定时任务会丢失。

**解决方案**：
- 方案一（推荐）：在应用启动时从 MongoDB 读取所有激活的计划并重新注册
- 方案二：使用 APScheduler 的持久化功能（需要额外配置数据库）
- 选择方案一，因为更简单且与现有架构一致

### 3. 并发更新冲突

**问题**：多个定时任务同时更新同一股票，或手动更新与定时更新冲突。

**解决方案**：
- 使用 MongoDB 的 `find_one_and_update` 原子操作
- 使用 `upsert` 操作，确保幂等性
- 记录更新时间戳，可以判断数据新鲜度

### 4. 大量股票的批量更新

**问题**：如果有很多股票需要更新，可能影响服务性能。

**解决方案**：
- 使用异步任务队列（可选，初期使用同步更新）
- 限制并发更新数量
- 分批更新，避免一次性更新过多股票
- 监控更新耗时，设置超时机制

### 5. yfinance API 限制

**问题**：Yahoo Finance 可能有请求频率限制。

**解决方案**：
- 在更新任务中添加延迟（如每次更新间隔 1-2 秒）
- 实现重试机制（指数退避）
- 监控 API 调用频率
- 如果遇到限制，记录错误并稍后重试

## 技术选型依据

### 1. 为什么选择独立的服务？

- **职责分离**：股票信息服务是独立的业务模块，单独服务便于维护和扩展
- **技术栈一致**：使用 Python + FastAPI，与现有 python-service 保持一致
- **独立部署**：可以独立扩展和部署，不影响其他服务

### 2. 为什么使用 APScheduler 而不是 Celery？

- **简单性**：APScheduler 更轻量，不需要额外的消息队列（Redis/RabbitMQ）
- **集成简单**：与 FastAPI 集成更直接
- **功能足够**：对于定时任务需求，APScheduler 功能已足够
- **异步支持**：支持 AsyncIOScheduler，与 FastAPI 异步特性匹配

### 3. 为什么使用 MongoDB 存储更新计划？

- **统一数据存储**：与股票数据使用同一数据库，简化架构
- **灵活查询**：MongoDB 的查询能力足够满足需求
- **易于扩展**：后续可以添加更多字段和功能

## 参考资料来源

- [yfinance 官方文档](https://github.com/ranaroussi/yfinance)
- [APScheduler 官方文档](https://apscheduler.readthedocs.io/)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [Motor (MongoDB 异步驱动) 文档](https://motor.readthedocs.io/)
- [Yahoo Finance API 文档](https://www.yahoofinanceapi.com/)（参考）

## 待确认事项

### ⚠️ 需要用户确认的关键点

1. **数据字段范围**：
   - 除了基本信息（名称、代码、市场等），是否需要其他字段？
   - 是否需要历史价格数据？财务数据？

2. **更新频率**：
   - 默认的更新频率是多少？（如：每个工作日 9:00）
   - 是否支持不同股票设置不同的更新频率？

3. **模糊查询实现**：
   - 股票名称模糊查询是使用 MongoDB 的文本索引，还是正则表达式？
   - 是否需要支持多字段组合查询？

4. **错误处理策略**：
   - 如果 yfinance 抓取失败，是否重试？重试几次？
   - 是否需要通知机制（如发送告警）？

5. **性能要求**：
   - 预期支持多少只股票？
   - 查询接口的响应时间要求？

---

**等待用户确认后开始实现**
