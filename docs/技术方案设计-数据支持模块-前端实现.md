# 技术方案设计 - 数据支持模块（前端实现）

> **项目状态**：设计阶段  
> **创建时间**：2025-01-12  
> **文档位置**：docs/  
> **优先级**：P0 - 最高优先级

## 项目概述

本文档描述数据支持模块的前端实现方案，包括历史数据管理、技术指标计算、数据质量检查、数据同步等功能的页面设计和交互实现。

## 技术栈

### 现有技术栈（保持不变）
- **框架**：Nuxt 3 + Vue 3 (Composition API)
- **UI 组件库**：Shadcn UI + Tailwind CSS
- **状态管理**：Pinia（可选）
- **HTTP 客户端**：Fetch API（通过适配器模式）
- **包管理**：pnpm

### 新增技术需求
- **图表库**：用于技术指标可视化
  - **推荐**：ECharts（功能强大，支持多种图表类型）
  - **备用**：Chart.js（轻量级，易于使用）
- **日期选择器**：用于时间范围选择
  - **推荐**：Shadcn UI 的 Calendar 组件（已集成）
- **SSE 支持**：用于实时进度追踪
  - **使用**：EventSource API（浏览器原生支持）

## 页面设计

### 1. 历史数据管理页

**页面路径**：`/stocks/data/history`

**页面功能**：
- 历史K线数据查询（按股票、时间范围、周期）
- 历史K线数据更新（单只、批量、全量）
- 历史K线数据删除（清理过期数据）
- 历史K线数据统计（数据覆盖范围、数据量统计）
- 历史K线数据可视化（K线图）

**页面结构**：
```
┌─────────────────────────────────────────────────────────┐
│  Header: 历史数据管理 | [刷新] [批量更新] [删除]        │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  查询条件                                          │ │
│  │  [股票代码/名称] [时间周期▼] [开始日期] [结束日期]│ │
│  │  [查询] [重置]                                    │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  数据统计卡片                                      │ │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐            │ │
│  │  │ 总数 │ │ 覆盖 │ │ 缺失 │ │ 最新 │            │ │
│  │  │ 1000 │ │ 90%  │ │ 100  │ │ 今天 │            │ │
│  │  └──────┘ └──────┘ └──────┘ └──────┘            │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  K线图（ECharts）                                  │ │
│  │  [日线] [周线] [月线] [切换周期]                  │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  数据列表（表格）                                   │ │
│  │  [日期] [开盘] [最高] [最低] [收盘] [成交量]      │ │
│  │  [分页控件]                                        │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**交互设计**：
1. **查询功能**：
   - 支持按股票代码/名称搜索（自动补全）
   - 支持选择时间周期（1m, 5m, 15m, 30m, 60m, 1d, 1w, 1M）
   - 支持选择时间范围（开始日期、结束日期）
   - 查询结果实时更新K线图和数据列表

2. **数据更新功能**：
   - 单只股票更新：点击"更新"按钮，显示加载状态
   - 批量更新：选择多只股票，点击"批量更新"，使用 SSE 显示进度
   - 全量更新：点击"全量更新"，使用 SSE 显示进度

3. **数据可视化**：
   - K线图使用 ECharts 的 candlestick 图表
   - 支持切换时间周期（日线、周线、月线）
   - 支持缩放和平移
   - 显示技术指标（可选，如 MA、MACD）

4. **数据统计**：
   - 实时显示数据总数、覆盖率、缺失数据数、最新数据日期
   - 点击统计卡片可以查看详细信息

### 2. 技术指标计算页

**页面路径**：`/stocks/data/indicators`

**页面功能**：
- 技术指标计算（单指标、批量指标）
- 技术指标查询（按股票、指标类型、时间范围）
- 技术指标可视化（指标图表）
- 支持的指标列表展示

**页面结构**：
```
┌─────────────────────────────────────────────────────────┐
│  Header: 技术指标计算 | [刷新] [批量计算]                │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  计算条件                                          │ │
│  │  [股票代码/名称] [时间周期▼] [指标类型▼]         │ │
│  │  [开始日期] [结束日期] [计算] [重置]              │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  支持的指标列表（卡片）                             │ │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐            │ │
│  │  │ MA   │ │ RSI  │ │ MACD │ │ BOLL │            │ │
│  │  │ 移动 │ │ 相对 │ │ 指数 │ │ 布林 │            │ │
│  │  │ 平均 │ │ 强弱 │ │ 平滑 │ │ 带   │            │ │
│  │  └──────┘ └──────┘ └──────┘ └──────┘            │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  指标图表（ECharts）                               │ │
│  │  [K线图 + 指标叠加] [切换指标] [切换周期]         │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  指标数据列表（表格）                               │ │
│  │  [日期] [指标值] [参数] [操作]                    │ │
│  │  [分页控件]                                        │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**交互设计**：
1. **指标计算功能**：
   - 支持选择单个指标或批量指标（多选）
   - 支持自定义指标参数（如 MA20 的周期 20）
   - 计算过程使用 SSE 显示进度
   - 计算结果自动保存并显示

2. **指标可视化**：
   - K线图 + 指标叠加显示（如 MA 叠加在K线图上）
   - 支持切换不同指标（MA、RSI、MACD、BOLL 等）
   - 支持切换时间周期
   - 支持缩放和平移

3. **指标查询功能**：
   - 支持按股票、指标类型、时间范围查询
   - 查询结果实时更新图表和数据列表

4. **支持的指标展示**：
   - 以卡片形式展示所有支持的指标
   - 点击卡片可以快速选择该指标
   - 显示指标描述和参数说明

### 3. 数据质量检查页

**页面路径**：`/stocks/data/quality`

**页面功能**：
- 数据质量检查（完整性、准确性、一致性、重复检查）
- 数据质量报告展示
- 数据修复功能（自动修复、手动修复）

**页面结构**：
```
┌─────────────────────────────────────────────────────────┐
│  Header: 数据质量检查 | [刷新] [自动修复]                │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  检查条件                                          │ │
│  │  [股票代码/名称] [时间周期▼] [开始日期] [结束日期]│ │
│  │  [运行检查] [重置]                                │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  质量检查结果（卡片）                               │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │ │
│  │  │ 完整性   │ │ 准确性   │ │ 一致性   │        │ │
│  │  │ ✅ 通过  │ │ ⚠️ 警告  │ │ ✅ 通过  │        │ │
│  │  │ 缺失: 0  │ │ 异常: 2   │ │ 不一致: 0│        │ │
│  │  └──────────┘ └──────────┘ └──────────┘        │ │
│  │  ┌──────────┐                                    │ │
│  │  │ 重复检查 │                                    │ │
│  │  │ ✅ 通过  │                                    │ │
│  │  │ 重复: 0  │                                    │ │
│  │  └──────────┘                                    │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  问题详情列表（表格）                               │ │
│  │  [类型] [日期] [描述] [状态] [操作]              │ │
│  │  [分页控件]                                        │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**交互设计**：
1. **质量检查功能**：
   - 支持选择股票、时间周期、时间范围
   - 点击"运行检查"后，显示检查进度
   - 检查完成后，显示检查结果（通过/警告/失败）

2. **质量报告展示**：
   - 以卡片形式展示各项检查结果（完整性、准确性、一致性、重复检查）
   - 显示问题数量和状态
   - 点击卡片可以查看详细问题列表

3. **数据修复功能**：
   - 支持自动修复（点击"自动修复"按钮）
   - 支持手动修复（在问题详情列表中，点击"修复"按钮）
   - 修复过程使用 SSE 显示进度
   - 修复完成后，自动刷新检查结果

### 4. 数据同步管理页

**页面路径**：`/stocks/data/sync`

**页面功能**：
- 数据同步状态查看
- 手动触发数据同步
- 同步任务管理（查看历史任务、任务状态）

**页面结构**：
```
┌─────────────────────────────────────────────────────────┐
│  Header: 数据同步管理 | [刷新] [手动同步]                │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  同步状态（卡片）                                   │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │ │
│  │  │ 上次同步 │ │ 下次同步 │ │ 同步状态 │        │ │
│  │  │ 2025-01-│ │ 2025-01-│ │ ✅ 正常   │        │ │
│  │  │ 12 18:00 │ │ 13 18:00 │ │          │        │ │
│  │  └──────────┘ └──────────┘ └──────────┘        │ │
│  └───────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────┐ │
│  │  同步任务列表（表格）                               │ │
│  │  [市场] [周期] [状态] [开始时间] [结束时间] [操作]│ │
│  │  [分页控件]                                        │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**交互设计**：
1. **同步状态查看**：
   - 显示上次同步时间、下次同步时间、同步状态
   - 实时更新同步状态（如果正在同步）

2. **手动同步功能**：
   - 点击"手动同步"按钮，弹出同步配置对话框
   - 选择市场、时间周期、是否增量更新
   - 确认后开始同步，使用 SSE 显示进度

3. **同步任务管理**：
   - 显示历史同步任务列表
   - 支持查看任务详情（进度、日志）
   - 支持取消正在运行的任务

## API 封装设计

### 1. API 服务封装

**文件位置**：`frontend/app/api/services/historical-data.ts`

**设计模式**：与现有 `stocks.ts` 保持一致

```typescript
/**
 * Historical Data 服务 API 封装
 * 通过 BFF 层调用历史数据服务
 */

import type { PaginatedResponse, HistoricalData, HistoricalDataQueryParams } from '../types'
import { BffAdapter } from '../adapters/bff'
import { ApiClient } from '../client'

export class HistoricalDataService {
  private client: ApiClient
  private basePath = '/v1/views/historical-data'

  constructor(bffApiUrl: string) {
    const adapter = new BffAdapter(bffApiUrl)
    this.client = new ApiClient(adapter)
  }

  /**
   * 获取历史K线数据
   */
  async getKlineData(
    ticker: string,
    params?: {
      period?: string
      start_date?: string
      end_date?: string
      limit?: number
    }
  ): Promise<HistoricalData[]> {
    const queryParams = new URLSearchParams()
    if (params?.period) queryParams.append('period', params.period)
    if (params?.start_date) queryParams.append('start_date', params.start_date)
    if (params?.end_date) queryParams.append('end_date', params.end_date)
    if (params?.limit) queryParams.append('limit', params.limit.toString())

    const queryString = queryParams.toString()
    const url = queryString 
      ? `${this.basePath}/${ticker}?${queryString}` 
      : `${this.basePath}/${ticker}`

    const response = await this.client.get<{ data: HistoricalData[] }>(url)
    return response.data?.data || []
  }

  /**
   * 更新历史K线数据
   */
  async updateKlineData(
    ticker: string,
    params?: {
      period?: string
      incremental?: boolean
      data_source?: string
    }
  ): Promise<{ updated_count: number; new_count: number }> {
    const queryParams = new URLSearchParams()
    if (params?.period) queryParams.append('period', params.period)
    if (params?.incremental !== undefined) queryParams.append('incremental', params.incremental.toString())
    if (params?.data_source) queryParams.append('data_source', params.data_source)

    const queryString = queryParams.toString()
    const url = queryString 
      ? `${this.basePath}/${ticker}/update?${queryString}` 
      : `${this.basePath}/${ticker}/update`

    const response = await this.client.post<{ data: { updated_count: number; new_count: number } }>(url)
    return response.data?.data || { updated_count: 0, new_count: 0 }
  }

  /**
   * 批量更新历史K线数据（SSE）
   */
  async batchUpdateKlineData(
    tickers: string[],
    params?: {
      period?: string
      start_date?: string
      end_date?: string
    },
    onProgress?: (progress: any) => void
  ): Promise<void> {
    // 使用 EventSource 接收 SSE 进度更新
    const queryParams = new URLSearchParams()
    queryParams.append('tickers', tickers.join(','))
    if (params?.period) queryParams.append('period', params.period)
    if (params?.start_date) queryParams.append('start_date', params.start_date)
    if (params?.end_date) queryParams.append('end_date', params.end_date)

    const url = `${this.basePath}/batch?${queryParams.toString()}`
    const eventSource = new EventSource(url)

    eventSource.onmessage = (event) => {
      const progress = JSON.parse(event.data)
      if (onProgress) {
        onProgress(progress)
      }
      if (progress.stage === 'completed' || progress.stage === 'error') {
        eventSource.close()
      }
    }

    eventSource.onerror = (error) => {
      console.error('SSE error:', error)
      eventSource.close()
      throw new Error('批量更新失败')
    }
  }

  /**
   * 获取历史K线数据统计
   */
  async getKlineDataStatistics(
    ticker?: string,
    period?: string
  ): Promise<{
    total_count: number
    start_date: string
    end_date: string
    missing_dates: string[]
  }> {
    const queryParams = new URLSearchParams()
    if (period) queryParams.append('period', period)

    const queryString = queryParams.toString()
    const url = ticker
      ? queryString
        ? `${this.basePath}/${ticker}/statistics?${queryString}`
        : `${this.basePath}/${ticker}/statistics`
      : queryString
        ? `${this.basePath}/statistics?${queryString}`
        : `${this.basePath}/statistics`

    const response = await this.client.get<{ data: any }>(url)
    return response.data?.data || {
      total_count: 0,
      start_date: '',
      end_date: '',
      missing_dates: []
    }
  }
}

/**
 * 创建 Historical Data 服务实例
 */
export function createHistoricalDataService(bffApiUrl: string): HistoricalDataService {
  return new HistoricalDataService(bffApiUrl)
}
```

### 2. Composables 封装

**文件位置**：`frontend/app/composables/useHistoricalData.ts`

**设计模式**：与现有 `useApi.ts` 保持一致

```typescript
import { createHistoricalDataService } from '~/api/services/historical-data'
import { useRuntimeConfig } from '#app'

export function useHistoricalDataService() {
  const config = useRuntimeConfig()
  const bffApiUrl = config.public.bffApiUrl || 'http://localhost:4000/api/bff'
  
  return createHistoricalDataService(bffApiUrl)
}
```

### 3. 类型定义

**文件位置**：`frontend/app/api/types.ts`（扩展现有文件）

```typescript
// 历史K线数据类型
export interface HistoricalData {
  date: string
  timestamp: string
  open: number
  high: number
  low: number
  close: number
  volume: number
  amount?: number
  adj_close?: number
  data_source: string
}

// 历史数据查询参数
export interface HistoricalDataQueryParams {
  ticker?: string
  period?: string
  start_date?: string
  end_date?: string
  limit?: number
}

// 技术指标数据类型
export interface IndicatorData {
  date: string
  timestamp: string
  value: number
  params?: {
    period?: number
    fast?: number
    slow?: number
    [key: string]: any
  }
}

// 技术指标查询参数
export interface IndicatorQueryParams {
  ticker?: string
  indicator_name?: string
  period?: string
  start_date?: string
  end_date?: string
  limit?: number
}

// 数据质量检查结果
export interface DataQualityResult {
  completeness: {
    status: 'passed' | 'warning' | 'failed'
    missing_count: number
  }
  accuracy: {
    status: 'passed' | 'warning' | 'failed'
    abnormal_count: number
  }
  consistency: {
    status: 'passed' | 'warning' | 'failed'
    inconsistent_count: number
  }
  duplicate: {
    status: 'passed' | 'warning' | 'failed'
    duplicate_count: number
  }
}
```

## 组件设计

### 1. K线图组件

**文件位置**：`frontend/app/components/stocks/KlineChart.vue`

**功能**：
- 使用 ECharts 渲染K线图
- 支持技术指标叠加显示
- 支持缩放和平移
- 支持切换时间周期

**Props**：
```typescript
interface Props {
  data: HistoricalData[]
  indicators?: IndicatorData[]
  period?: string
}
```

### 2. 指标图表组件

**文件位置**：`frontend/app/components/stocks/IndicatorChart.vue`

**功能**：
- 使用 ECharts 渲染指标图表
- 支持K线图 + 指标叠加显示
- 支持切换不同指标
- 支持缩放和平移

**Props**：
```typescript
interface Props {
  klineData: HistoricalData[]
  indicatorData: IndicatorData[]
  indicatorName: string
  period?: string
}
```

### 3. 数据质量卡片组件

**文件位置**：`frontend/app/components/stocks/DataQualityCard.vue`

**功能**：
- 显示数据质量检查结果
- 支持点击查看详细信息

**Props**：
```typescript
interface Props {
  title: string
  status: 'passed' | 'warning' | 'failed'
  count: number
  description?: string
}
```

### 4. SSE 进度组件

**文件位置**：`frontend/app/components/common/SSEProgress.vue`

**功能**：
- 显示 SSE 实时进度
- 支持进度条、统计信息、预计剩余时间

**Props**：
```typescript
interface Props {
  progress: {
    stage: string
    message: string
    progress: number
    total?: number
    current?: number
    [key: string]: any
  }
}
```

## 路由设计

**文件位置**：`frontend/app/pages/stocks/data/`

```
stocks/data/
├── history.vue          # 历史数据管理页
├── indicators.vue       # 技术指标计算页
├── quality.vue          # 数据质量检查页
└── sync.vue             # 数据同步管理页
```

**路由配置**：
- `/stocks/data/history` → 历史数据管理页
- `/stocks/data/indicators` → 技术指标计算页
- `/stocks/data/quality` → 数据质量检查页
- `/stocks/data/sync` → 数据同步管理页

## 导航菜单更新

**文件位置**：`frontend/app/constants/menus.ts`

**更新内容**：
- 在 Stocks 菜单下添加"数据支持"子菜单
- 包含历史数据管理、技术指标计算、数据质量检查、数据同步管理四个子项

## 实施步骤

### Phase 1：基础页面和 API 封装
1. 创建 API 服务封装（historical-data.ts, indicators.ts, data-quality.ts, data-sync.ts）
2. 创建 Composables 封装
3. 创建类型定义
4. 创建基础页面结构（路由和布局）

### Phase 2：历史数据管理页
1. 实现查询功能
2. 实现数据更新功能（单只、批量）
3. 实现K线图组件
4. 实现数据统计展示

### Phase 3：技术指标计算页
1. 实现指标计算功能
2. 实现指标查询功能
3. 实现指标图表组件
4. 实现支持的指标列表展示

### Phase 4：数据质量检查页
1. 实现质量检查功能
2. 实现质量报告展示
3. 实现数据修复功能

### Phase 5：数据同步管理页
1. 实现同步状态查看
2. 实现手动同步功能
3. 实现同步任务管理

## 注意事项

1. **向后兼容**：
   - 新增页面不影响现有页面
   - 新增 API 服务不影响现有服务
   - 新增组件不影响现有组件

2. **性能优化**：
   - 大数据量查询使用分页
   - 图表数据使用虚拟滚动（如果数据量很大）
   - SSE 连接及时关闭，避免资源浪费

3. **用户体验**：
   - 所有异步操作显示加载状态
   - 错误信息友好提示
   - 操作成功提示

4. **代码规范**：
   - 遵循现有代码风格
   - 使用 TypeScript 类型定义
   - 组件和函数命名清晰

---

**前端实现方案设计已完成**

**参考文档**：
- `docs/技术方案设计-数据支持模块-后台服务.md`（后台服务 API 设计）
- `docs/技术方案设计-数据支持模块-BFF层实现.md`（BFF 层 API 设计）
