# 技术路线 - 数据支持模块（服务层）

> **任务状态**：待开始  
> **创建时间**：2025-01-12  
> **文档位置**：docs/  
> **说明**：本文档仅用于当前任务，任务完成后可归档或删除  
> **优先级**：P0 - 最高优先级

## 任务概述

实现数据支持模块的后台服务层，包括历史K线数据获取与存储、技术指标计算、数据质量保证、数据同步与更新等核心功能。

## 任务拆解

### 阶段 1：数据模型和基础架构（核心基础）

#### 任务 1.1：实现 MongoDB TimeSeries Collection 数据模型
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级，必须先完成）
- **描述**：创建历史K线数据和技术指标数据的 MongoDB TimeSeries Collection，使用 metafield 优化存储
- **内容**：
  - 创建 `kline_data` TimeSeries Collection（使用 metafield：ticker, market, period）
  - 创建 `indicator_data` TimeSeries Collection（使用 metafield：ticker, period, indicator_type, indicator_name）
  - 创建 `data_quality_logs` 普通 Collection
  - 实现集合初始化函数（`app/models/kline_data.py`, `app/models/indicator_data.py`）
  - 实现数据模型转换函数（from_dict, prepare_document）
- **验收标准**：
  - [ ] TimeSeries Collection 创建成功
  - [ ] metafield 配置正确
  - [ ] 数据模型转换函数正常工作
  - [ ] 可以成功插入和查询测试数据
- **输出**：
  - `app/models/kline_data.py` - K线数据模型
  - `app/models/indicator_data.py` - 指标数据模型
  - `app/models/data_quality.py` - 数据质量日志模型

#### 任务 1.2：实现历史数据服务基础架构
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：创建历史数据服务模块的基础架构，按功能拆分服务类
- **内容**：
  - 创建 `app/services/historical_data/` 目录结构
  - 实现 `HistoricalDataService` 核心服务类（协调各个子服务）
  - 实现 `HistoricalDataFetcher` 数据获取服务（从数据源获取K线数据）
  - 实现 `HistoricalDataStorage` 数据存储服务（保存K线数据到MongoDB）
  - 实现 `HistoricalDataQuery` 数据查询服务（查询K线数据）
  - 实现基础方法框架（方法签名和文档字符串）
- **验收标准**：
  - [ ] 服务类结构清晰，职责分离
  - [ ] 所有方法签名定义完整
  - [ ] 服务类可以正常实例化和调用
- **输出**：
  - `app/services/historical_data/__init__.py`
  - `app/services/historical_data/historical_data_service.py`
  - `app/services/historical_data/historical_data_fetcher.py`
  - `app/services/historical_data/historical_data_storage.py`
  - `app/services/historical_data/historical_data_query.py`

### 阶段 2：历史数据服务实现（核心功能）

#### 任务 2.1：实现历史K线数据获取功能
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：实现从数据源（yfinance/akshare）获取历史K线数据的功能
- **内容**：
  - 在 `HistoricalDataFetcher` 中实现 `fetch_from_yfinance` 方法
  - 在 `HistoricalDataFetcher` 中实现 `fetch_from_akshare` 方法
  - 实现数据格式转换（转换为统一格式）
  - 实现错误处理和重试机制
  - 支持多时间周期（1m, 5m, 15m, 30m, 60m, 1d, 1w, 1M）
- **验收标准**：
  - [ ] 可以从 yfinance 获取美股/港股历史K线数据
  - [ ] 可以从 akshare 获取A股历史K线数据
  - [ ] 数据格式转换正确
  - [ ] 错误处理和重试机制正常工作
- **依赖**：任务 1.2
- **输出**：`HistoricalDataFetcher` 完整实现

#### 任务 2.2：实现历史K线数据存储功能
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：实现将历史K线数据保存到 MongoDB TimeSeries Collection 的功能
- **内容**：
  - 在 `HistoricalDataStorage` 中实现 `save_kline_data` 方法
  - 在 `HistoricalDataStorage` 中实现 `upsert_kline_data` 方法（避免重复数据）
  - 实现批量插入优化（使用 bulk_write）
  - 实现数据验证（字段完整性、数据范围）
  - 实现重复数据检测和处理
- **验收标准**：
  - [ ] 可以成功保存K线数据到 MongoDB
  - [ ] 重复数据检测和处理正常
  - [ ] 批量插入性能满足要求
  - [ ] 数据验证正常工作
- **依赖**：任务 1.1, 1.2
- **输出**：`HistoricalDataStorage` 完整实现

#### 任务 2.3：实现历史K线数据查询功能
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：实现从 MongoDB 查询历史K线数据的功能
- **内容**：
  - 在 `HistoricalDataQuery` 中实现 `query_by_ticker` 方法
  - 在 `HistoricalDataQuery` 中实现 `get_latest_date` 方法
  - 在 `HistoricalDataQuery` 中实现 `get_statistics` 方法
  - 实现时间范围查询优化
  - 实现分页查询支持
- **验收标准**：
  - [ ] 可以按股票、时间范围、周期查询K线数据
  - [ ] 查询性能满足要求（< 500ms）
  - [ ] 统计数据计算正确
- **依赖**：任务 1.1, 1.2
- **输出**：`HistoricalDataQuery` 完整实现

#### 任务 2.4：实现历史数据服务核心功能集成
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：在 `HistoricalDataService` 中集成各个子服务，实现完整的业务逻辑
- **内容**：
  - 实现 `fetch_kline_data` 方法（获取单只股票数据，自动补全缺失数据）
  - 实现 `fetch_batch_kline_data` 方法（批量获取，支持 SSE 进度推送）
  - 实现 `save_kline_data` 方法（保存数据）
  - 实现 `query_kline_data` 方法（查询数据）
  - 实现 `update_kline_data_incremental` 方法（增量更新）
  - 实现 `get_kline_data_statistics` 方法（统计数据）
- **验收标准**：
  - [ ] 所有核心方法正常工作
  - [ ] 数据获取、存储、查询流程完整
  - [ ] 增量更新逻辑正确
  - [ ] SSE 进度推送正常
- **依赖**：任务 2.1, 2.2, 2.3
- **输出**：`HistoricalDataService` 完整实现

### 阶段 3：技术指标服务实现（核心功能）

#### 任务 3.1：实现技术指标计算引擎
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：创建技术指标服务模块，实现基础指标计算功能
- **内容**：
  - 创建 `app/services/indicators/` 目录结构
  - 实现 `IndicatorCalculator` 指标计算服务
  - 安装和配置 TA-Lib（或 pandas-ta 作为备用）
  - 实现基础指标计算：MA、EMA、RSI、MACD、BOLL
  - 实现指标计算的数据验证和错误处理
- **验收标准**：
  - [ ] TA-Lib 或 pandas-ta 安装成功
  - [ ] 基础指标计算功能正常
  - [ ] 计算结果准确（与标准工具对比）
- **依赖**：任务 2.4（需要历史K线数据）
- **输出**：
  - `app/services/indicators/__init__.py`
  - `app/services/indicators/indicator_calculator.py`

#### 任务 3.2：实现技术指标存储和查询功能
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：实现技术指标数据的存储和查询功能
- **内容**：
  - 实现 `IndicatorStorage` 指标存储服务（保存指标数据到 MongoDB）
  - 实现 `IndicatorQuery` 指标查询服务（查询指标数据）
  - 实现指标数据缓存机制（避免重复计算）
  - 实现批量指标数据保存优化
- **验收标准**：
  - [ ] 可以成功保存指标数据到 MongoDB
  - [ ] 可以按股票、指标类型、时间范围查询指标数据
  - [ ] 缓存机制正常工作
- **依赖**：任务 1.1, 3.1
- **输出**：
  - `app/services/indicators/indicator_storage.py`
  - `app/services/indicators/indicator_query.py`

#### 任务 3.3：实现技术指标服务核心功能集成
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：在 `IndicatorService` 中集成各个子服务，实现完整的业务逻辑
- **内容**：
  - 实现 `IndicatorService` 核心服务类
  - 实现 `calculate_indicator` 方法（计算单个指标）
  - 实现 `calculate_batch_indicators` 方法（批量计算，支持 SSE 进度推送）
  - 实现 `query_indicator_data` 方法（查询指标数据）
  - 实现指标计算缓存逻辑（检查已有数据，避免重复计算）
- **验收标准**：
  - [ ] 所有核心方法正常工作
  - [ ] 指标计算、存储、查询流程完整
  - [ ] 缓存机制正常工作
  - [ ] SSE 进度推送正常
- **依赖**：任务 3.1, 3.2
- **输出**：`app/services/indicators/indicator_service.py` 完整实现

### 阶段 4：数据质量检查服务实现（重要功能）

#### 任务 4.1：实现数据质量检查服务
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐（重要）
- **描述**：创建数据质量检查服务模块，实现完整性、准确性、一致性、重复检查
- **内容**：
  - 创建 `app/services/data_quality/` 目录结构
  - 实现 `CompletenessChecker` 完整性检查服务
  - 实现 `AccuracyChecker` 准确性检查服务
  - 实现 `ConsistencyChecker` 一致性检查服务
  - 实现 `DataFixer` 数据修复服务
  - 实现 `DataQualityService` 核心服务类（协调各个子服务）
- **验收标准**：
  - [ ] 完整性检查正常工作（缺失数据检测）
  - [ ] 准确性检查正常工作（异常值检测）
  - [ ] 一致性检查正常工作（价格逻辑检查）
  - [ ] 数据修复功能正常工作
- **依赖**：任务 2.4（需要历史K线数据）
- **输出**：
  - `app/services/data_quality/__init__.py`
  - `app/services/data_quality/data_quality_service.py`
  - `app/services/data_quality/completeness_checker.py`
  - `app/services/data_quality/accuracy_checker.py`
  - `app/services/data_quality/consistency_checker.py`
  - `app/services/data_quality/data_fixer.py`

### 阶段 5：数据同步服务实现（重要功能）

#### 任务 5.1：实现数据同步服务
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐（重要）
- **描述**：创建数据同步服务模块，实现定时任务和增量更新功能
- **内容**：
  - 创建 `app/services/data_sync/` 目录结构
  - 安装和配置 APScheduler
  - 实现 `SyncScheduler` 同步调度器（管理定时任务）
  - 实现 `SyncExecutor` 同步执行器（执行同步任务）
  - 实现 `DataSyncService` 核心服务类（协调各个子服务）
  - 实现定时任务配置（每日同步A股/美股数据）
- **验收标准**：
  - [ ] APScheduler 安装和配置成功
  - [ ] 定时任务可以正常启动和运行
  - [ ] 增量更新逻辑正确
  - [ ] 同步失败重试机制正常工作
- **依赖**：任务 2.4（需要历史数据服务）
- **输出**：
  - `app/services/data_sync/__init__.py`
  - `app/services/data_sync/data_sync_service.py`
  - `app/services/data_sync/sync_scheduler.py`
  - `app/services/data_sync/sync_executor.py`

### 阶段 6：API 路由实现（接口层）

#### 任务 6.1：实现历史数据 API 路由
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：创建历史数据 API 路由，提供 RESTful 接口
- **内容**：
  - 创建 `app/routers/historical_data.py`
  - 实现 `GET /api/v1/historical-data/{ticker}` 接口（获取历史K线数据）
  - 实现 `POST /api/v1/historical-data/{ticker}/update` 接口（更新历史K线数据）
  - 实现 `POST /api/v1/historical-data/batch` 接口（批量更新，SSE）
  - 实现 `DELETE /api/v1/historical-data/{ticker}` 接口（删除历史K线数据）
  - 实现 `GET /api/v1/historical-data/{ticker}/statistics` 接口（获取统计数据）
  - 实现请求参数验证（Pydantic Schema）
  - 实现错误处理和统一响应格式
- **验收标准**：
  - [ ] 所有 API 接口正常工作
  - [ ] 请求参数验证正确
  - [ ] 错误处理完善
  - [ ] SSE 接口正常工作
- **依赖**：任务 2.4
- **输出**：
  - `app/routers/historical_data.py`
  - `app/schemas/historical_data.py`（Pydantic Schema）

#### 任务 6.2：实现技术指标 API 路由
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：创建技术指标 API 路由，提供 RESTful 接口
- **内容**：
  - 创建 `app/routers/indicators.py`
  - 实现 `POST /api/v1/indicators/calculate` 接口（计算技术指标）
  - 实现 `POST /api/v1/indicators/batch-calculate` 接口（批量计算，SSE）
  - 实现 `GET /api/v1/indicators/{ticker}` 接口（查询技术指标数据）
  - 实现 `GET /api/v1/indicators/supported` 接口（获取支持的指标列表）
  - 实现请求参数验证（Pydantic Schema）
  - 实现错误处理和统一响应格式
- **验收标准**：
  - [ ] 所有 API 接口正常工作
  - [ ] 请求参数验证正确
  - [ ] 错误处理完善
  - [ ] SSE 接口正常工作
- **依赖**：任务 3.3
- **输出**：
  - `app/routers/indicators.py`
  - `app/schemas/indicators.py`（Pydantic Schema）

#### 任务 6.3：实现数据质量和同步 API 路由
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐（重要）
- **描述**：创建数据质量和同步 API 路由，提供 RESTful 接口
- **内容**：
  - 创建 `app/routers/data_quality.py`
  - 创建 `app/routers/data_sync.py`
  - 实现数据质量检查接口（`POST /api/v1/data-quality/check`）
  - 实现数据修复接口（`POST /api/v1/data-quality/fix`）
  - 实现数据同步接口（`POST /api/v1/data-sync/sync`，SSE）
  - 实现同步状态查询接口（`GET /api/v1/data-sync/status`）
  - 实现请求参数验证和错误处理
- **验收标准**：
  - [ ] 所有 API 接口正常工作
  - [ ] 请求参数验证正确
  - [ ] 错误处理完善
  - [ ] SSE 接口正常工作
- **依赖**：任务 4.1, 5.1
- **输出**：
  - `app/routers/data_quality.py`
  - `app/routers/data_sync.py`
  - `app/schemas/data_quality.py`（Pydantic Schema）
  - `app/schemas/data_sync.py`（Pydantic Schema）

### 阶段 7：服务集成和测试（质量保证）

#### 任务 7.1：集成所有服务到主应用
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐⭐（最高优先级）
- **描述**：将所有新服务集成到 FastAPI 主应用中
- **内容**：
  - 在 `app/main.py` 中注册新的路由
  - 配置服务依赖注入
  - 配置定时任务启动（在应用启动时启动调度器）
  - 确保不影响现有服务（向后兼容）
- **验收标准**：
  - [ ] 所有新路由可以正常访问
  - [ ] 服务依赖注入正常
  - [ ] 定时任务可以正常启动
  - [ ] 现有服务不受影响
- **依赖**：任务 6.1, 6.2, 6.3
- **输出**：更新后的 `app/main.py`

#### 任务 7.2：编写单元测试
- **状态**：待开始
- **优先级**：⭐⭐⭐⭐（重要）
- **描述**：为所有服务编写单元测试
- **内容**：
  - 为历史数据服务编写测试（`tests/test_historical_data_service.py`）
  - 为技术指标服务编写测试（`tests/test_indicator_service.py`）
  - 为数据质量服务编写测试（`tests/test_data_quality_service.py`）
  - 为数据同步服务编写测试（`tests/test_data_sync_service.py`）
  - 测试覆盖率 > 80%
- **验收标准**：
  - [ ] 所有单元测试通过
  - [ ] 测试覆盖率 > 80%
  - [ ] 测试覆盖正常流程和异常流程
- **依赖**：任务 7.1
- **输出**：测试文件

#### 任务 7.3：编写集成测试
- **状态**：待开始
- **优先级**：⭐⭐⭐（可选）
- **描述**：编写端到端集成测试
- **内容**：
  - 测试历史数据获取、存储、查询完整流程
  - 测试技术指标计算、存储、查询完整流程
  - 测试数据质量检查完整流程
  - 测试数据同步完整流程
- **验收标准**：
  - [ ] 所有集成测试通过
  - [ ] 端到端流程正常工作
- **依赖**：任务 7.1
- **输出**：集成测试文件

## 任务依赖关系图

```
阶段 1：数据模型和基础架构
├── 任务 1.1：MongoDB TimeSeries Collection 数据模型
└── 任务 1.2：历史数据服务基础架构

阶段 2：历史数据服务实现
├── 任务 2.1：历史K线数据获取功能（依赖 1.2）
├── 任务 2.2：历史K线数据存储功能（依赖 1.1, 1.2）
├── 任务 2.3：历史K线数据查询功能（依赖 1.1, 1.2）
└── 任务 2.4：历史数据服务核心功能集成（依赖 2.1, 2.2, 2.3）

阶段 3：技术指标服务实现
├── 任务 3.1：技术指标计算引擎（依赖 2.4）
├── 任务 3.2：技术指标存储和查询功能（依赖 1.1, 3.1）
└── 任务 3.3：技术指标服务核心功能集成（依赖 3.1, 3.2）

阶段 4：数据质量检查服务实现
└── 任务 4.1：数据质量检查服务（依赖 2.4）

阶段 5：数据同步服务实现
└── 任务 5.1：数据同步服务（依赖 2.4）

阶段 6：API 路由实现
├── 任务 6.1：历史数据 API 路由（依赖 2.4）
├── 任务 6.2：技术指标 API 路由（依赖 3.3）
└── 任务 6.3：数据质量和同步 API 路由（依赖 4.1, 5.1）

阶段 7：服务集成和测试
├── 任务 7.1：集成所有服务到主应用（依赖 6.1, 6.2, 6.3）
├── 任务 7.2：编写单元测试（依赖 7.1）
└── 任务 7.3：编写集成测试（依赖 7.1）
```

## 注意事项

1. **向后兼容**：
   - 所有新功能不影响现有服务
   - 使用独立的路由前缀（`/api/v1/historical-data/*`, `/api/v1/indicators/*`）
   - 使用独立的集合（`kline_data`, `indicator_data`）

2. **服务拆分**：
   - 严格按功能领域拆分服务模块
   - 每个服务类职责单一，避免一个文件包含太多功能
   - 服务之间通过接口依赖，便于测试

3. **数据模型**：
   - 使用 MongoDB TimeSeries Collection 的 metafield 特性
   - 股票信息通过文档引用，不嵌入时间序列数据
   - 合理设计索引，优化查询性能

4. **错误处理**：
   - 统一错误响应格式
   - 记录详细错误日志
   - 实现重试机制和降级策略

5. **性能优化**：
   - 批量操作使用 bulk_write
   - 查询使用索引优化
   - 计算结果缓存，避免重复计算

## 检查清单

### 代码质量检查
- [ ] 所有代码通过 lint 检查
- [ ] 所有代码通过类型检查
- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%

### 功能完整性检查
- [ ] 历史K线数据获取、存储、查询功能完整
- [ ] 技术指标计算、存储、查询功能完整
- [ ] 数据质量检查功能完整
- [ ] 数据同步功能完整
- [ ] 所有 API 接口正常工作

### 性能检查
- [ ] 查询性能满足要求（< 500ms）
- [ ] 批量操作性能满足要求
- [ ] 数据库索引优化正确

### 兼容性检查
- [ ] 不影响现有服务
- [ ] 向后兼容性保证
- [ ] 文档更新完整

---

**技术路线规划已完成**

**参考文档**：
- `docs/技术方案设计-数据支持模块-后台服务.md`（技术方案设计）
- `docs/技术调研-数据支持模块.md`（技术调研结果）
