# 项目开发通用规则

> 本文档定义了本项目的开发规范和 AI 协作规则，所有 AI 助手必须严格遵守。

## 🚨 代码质量保证（最高优先级）

### 核心原则
- **代码质量检查拥有绝对最高优先级**
- 禁止与任何其他操作（代码变更、提交等）并行执行
- 必须在以下关键节点执行质量检查：

### 强制检查点
1. **项目初始化后** - 确保基础架构正确
2. **任务标记完成前** - 验证功能实现
3. **Git 提交前** - 保证代码稳定性
4. **版本发布前** - 最终质量验证

### 检查标准
- ✅ **编译通过**：代码在所有目标环境可编译
- ✅ **执行成功**：程序运行符合预期
- ✅ **测试通过**：所有单元测试和 CI/CD 流程成功
- ✅ **功能验证**：核心功能按需求正常工作

### 单元测试要求（重要）

#### 测试时机
- **每次引入大的 feature 后**：必须编写对应的单元测试
- **每次实现核心功能模块后**：必须编写单元测试
- **每次修复重要 bug 后**：必须添加回归测试

#### 测试覆盖范围
- **API 端点**：所有 RESTful API 端点必须有测试
- **业务逻辑**：Service/Handler 层的核心逻辑必须有测试
- **数据模型**：数据验证和转换逻辑必须有测试
- **错误处理**：异常情况和边界条件必须有测试

#### 测试质量标准
- 测试用例应该覆盖正常流程和异常流程
- 测试应该独立、可重复、快速执行
- 测试命名清晰，描述测试意图
- 测试代码应该保持简洁，避免过度复杂

#### 测试框架
- **Python**: pytest + pytest-asyncio
- **Node.js**: Jest (Nest.js 内置)
- **Rust**: 内置测试框架 (cargo test)

---

## 📋 需求分析与技术方案

### 技术方案文档管理
- **创建文件**：`技术方案设计.md`
- **维护责任**：持续更新，确保文档与实际实现同步

### 必需内容结构
```markdown
# 技术方案设计

## 项目技术关键点
- [列出核心技术要点]

## 架构设计决策
- [记录架构选择及理由]

## 技术选型依据
- [说明技术栈选择原因]

## 技术难点与解决方案
- [详细分析技术挑战]

## 参考资料来源
- [列出研究资料链接]
```

### 技术难点研究流程
1. **识别难点** → 2. **网络搜索** → 3. **收集资料** → 4. **可行性论证** → 5. **文档记录**

### ⚠️ 重要：用户确认机制
- 技术方案必须经用户确认后才能进入实现阶段
- 在获得确认前，不得开始详细设计或编码

---

## 🗺️ 技术路线与任务管理

### 技术路线文档规范
- **命名格式**：`技术路线-{任务名称}.md`
- **作用范围**：仅用于当前任务，任务完成后可归档或删除
- **必需内容**：
  - 任务拆解（细化到可执行的最小单元）
  - 任务状态跟踪（待开始/进行中/已完成/已取消/阻塞中）
  - 任务依赖关系
  - 注意事项和检查清单

### 任务状态更新
- 开始任务时：将状态更新为"进行中"
- 完成任务时：立即更新为"已完成"
- 遇到阻塞时：更新为"阻塞中"并说明原因
- 取消任务时：更新为"已取消"并说明原因

---

## 🔄 版本控制规范

### Git 提交策略（重要）

#### 提交时机
1. **AI 完成代码后**：不立即提交，等待用户修改
2. **下次对话开始时**：
   - 首先汇总 AI 的代码变更和用户的修改
   - 识别所有变更的文件和内容
   - 进行 Git 提交（包含完整的变更说明）
   - 提交完成后再开始新的对话任务

#### 提交前检查清单
- [ ] 代码已通过质量检查
- [ ] 已汇总所有变更（AI + 用户）
- [ ] 提交信息清晰描述变更内容
- [ ] 遵循提交信息规范

#### 提交信息规范（遵循 Conventional Commits）

提交信息必须遵循以下格式：

```
<类型>(<范围>): <简短描述>

<详细说明（可选，空行分隔）>

<脚注（可选）>
```

**格式说明**：

1. **类型（必填）**：使用以下标准类型之一
   - `feat`: 新功能（feature）
   - `fix`: 修复 bug
   - `docs`: 仅文档变更
   - `style`: 代码格式变更（不影响代码运行，如空格、格式化、缺少分号等）
   - `refactor`: 代码重构（既不是新功能也不是 bug 修复）
   - `perf`: 性能优化
   - `test`: 添加或修改测试
   - `build`: 构建系统或外部依赖的变更（如 npm、webpack、gulp 等）
   - `ci`: CI 配置文件和脚本的变更
   - `chore`: 其他变更（不修改 src 或 test 文件）
   - `revert`: 回滚之前的提交

2. **范围（可选）**：指定变更影响的范围
   - 可以是模块名、服务名、组件名等
   - 例如：`feat(python-service)`, `fix(frontend)`, `refactor(items-api)`
   - 如果变更影响多个范围，可以省略范围或使用 `*`

3. **简短描述（必填）**：
   - 使用祈使语气，首字母小写，结尾不加句号
   - 不超过 72 个字符
   - 清晰描述提交做了什么

4. **详细说明（可选）**：
   - 空行分隔
   - 解释"为什么"而不是"做了什么"（做了什么在标题中已说明）
   - 可以包含变更的动机和与之前行为的对比

5. **脚注（可选）**：
   - `BREAKING CHANGE:` 后跟破坏性变更的描述
   - 或引用相关 issue：`Closes #123`, `Fixes #456`

**提交信息示例**：

```
feat(python-service): 添加 Items CRUD API

实现了完整的 Items 增删改查功能，包括：
- GET /api/v1/items - 获取所有 items
- GET /api/v1/items/{id} - 获取单个 item
- POST /api/v1/items - 创建 item
- PUT /api/v1/items/{id} - 更新 item
- DELETE /api/v1/items/{id} - 删除 item

使用 Motor 异步 MongoDB 驱动，提供统一的响应格式。

Closes #10
```

```
fix(node-service): 修复 Mongoose Schema 类型定义

在 Vitest 环境下，Mongoose Schema 需要显式指定 type 字段
以避免类型推断错误。

- 为所有 @Prop 装饰器添加 type 字段
- 修复了测试中的类型错误
```

```
refactor(test): 将 Node.js 测试框架从 Jest 迁移到 Vitest

- 移除 Jest 相关依赖和配置
- 添加 Vitest 配置文件和依赖
- 更新所有测试文件使用 Vitest API
- 修复测试兼容性问题

BREAKING CHANGE: 测试命令从 `jest` 改为 `vitest run`
```

```
docs: 更新 README 添加测试说明

添加了测试运行命令和测试框架说明。
```

**提交信息检查清单**：
- [ ] 类型使用标准类型之一
- [ ] 简短描述使用祈使语气，首字母小写
- [ ] 简短描述不超过 72 个字符
- [ ] 如果有详细说明，用空行分隔
- [ ] 破坏性变更已标注 `BREAKING CHANGE:`
- [ ] 相关 issue 已引用

### 分支管理策略
- 推荐从 main 创建功能分支：`feature/xxx`
- 在功能分支开发
- 合并前整理提交历史
- 使用临时分支 + cherry-pick 优化提交顺序

---

## 📝 开发过程记录

### 变更日志管理
- **文件**：`changelog.md`
- **文档开头**：必须说明文档功能和内容，便于 AI 获取上下文

### 初始记录格式
```markdown
# 开发变更日志

> 本文档记录项目开发过程中的重要变更，为后续 AI 协作提供上下文参考

## Commit-00 项目概述

### 技术栈信息
- [列出使用的技术栈]

### 项目结构
- [描述项目目录结构]

### 启动命令
- [记录开发/构建/部署命令]

### 其他关键信息
- [补充重要配置或说明]
```

### 提交记录规范
每次 Git 提交后添加新章节：

```markdown
## Commit-XX [提交标题]

### 主要变更点
- [列出核心变更]

### 详细变更说明
- [用自然语言解释变更原因和影响]

### 关键代码片段
```language
// 展示重要代码变更（不贴完整代码）
```

### 注意事项
- [记录需要注意的问题或后续工作]
```

### 📌 内容管理原则
- ✅ **仅允许追加**：只能在文档末尾添加新内容
- ⚠️ **过时标记**：对过时内容在开头标注 `（已过时）`
- 🚫 **禁止删除**：严禁删除或修改已存在的内容
- 📋 **保持完整**：确保开发历史的完整性和可追溯性

---

## 🛠️ 项目技术栈规范

### 前端
- **框架**：Vue 3 (Composition API)
- **元框架**：Nuxt.js 3
- **UI 组件库**：Shadcn UI + Tailwind CSS
- **状态管理**：Pinia
- **HTTP 客户端**：优先使用 Fetch API
- **包管理**：pnpm

### 后端服务
- **Python 服务**：FastAPI
  - **包管理**：uv
  - **数据库驱动**：Motor（异步）或 PyMongo
- **Node.js 服务**：Bun + Nest.js
  - **数据库驱动**：Mongoose
- **Rust 服务**：Axum
  - **包管理**：Cargo
  - **数据库驱动**：mongodb crate

### 数据库
- **类型**：MongoDB
- **连接管理**：每个服务独立管理数据库连接池

### 开发工具
- **代码格式化**：
  - 前端：Prettier
  - Python：Black
  - Rust：rustfmt
- **Linting**：
  - 前端：ESLint
  - Python：pylint
  - Rust：clippy

---

## 📁 项目结构规范

### Monorepo 结构
```
js-financial-kanban/
├── frontend/                 # 前端应用（Nuxt.js）
│   ├── pages/               # Nuxt 页面路由
│   ├── components/          # 组件
│   ├── composables/         # 组合式函数
│   ├── stores/              # Pinia 状态管理
│   ├── api/                 # API 调用封装
│   └── nuxt.config.ts
├── services/                # 后端服务
│   ├── python-service/      # Python FastAPI 服务
│   ├── node-service/        # Node.js (Bun + Nest.js) 服务
│   └── rust-service/        # Rust (Axum) 服务
├── shared/                  # 共享代码（类型定义、工具函数等）
├── docs/                    # 项目文档
├── .gitignore
├── .cursorrules            # 本规则文件
└── README.md
```

---

## 🔌 API 设计规范

### RESTful 风格
- 遵循 REST 设计原则
- 使用标准 HTTP 方法（GET、POST、PUT、DELETE）
- 资源命名使用复数形式（如 `/api/v1/items`）

### 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### API 版本控制
- 使用 `/api/v1/` 前缀
- 后续版本使用 `/api/v2/` 等

### 错误处理
- 统一错误码和错误信息格式
- 提供清晰的错误提示

---

## 🤖 AI 助手执行指南

### 行为优先级
1. **代码质量保证** (最高优先级)
2. **用户需求确认**
3. **技术方案验证**
4. **标准流程执行**
5. **文档维护更新**

### 执行检查清单
- [ ] 质量检查点已通过
- [ ] 技术方案已确认
- [ ] Git 状态正常
- [ ] 文档已更新
- [ ] 用户已告知关键信息

### 对话开始流程
1. **检查 Git 状态**：查看是否有未提交的变更
2. **汇总变更**：识别 AI 和用户的代码变更
3. **提交 Git**：如有变更，先提交再开始新任务
   - 使用规范的提交信息格式（Conventional Commits）
   - 确保提交信息清晰、完整
4. **读取上下文**：查看 changelog.md 和技术路线文档
5. **执行任务**：按照技术路线执行具体任务
6. **更新状态**：实时更新任务状态
7. **质量检查**：完成任务后进行质量验证

### 对话结束流程
1. **更新文档**：更新 changelog.md 和技术路线文档
2. **不提交 Git**：等待用户修改，下次对话时再提交
3. **总结工作**：向用户说明已完成的工作和待办事项

---

## 📚 文档管理规范

### 必需文档
- `README.md` - 项目介绍和快速开始
- `技术方案设计.md` - 技术架构和选型
- `changelog.md` - 开发变更日志
- `技术路线-{任务名称}.md` - 任务拆解和进度跟踪

### 文档更新原则
- 技术方案变更时，必须同步更新文档
- 每次提交后，更新 changelog.md
- 任务状态变更时，更新技术路线文档
- 保持文档与代码同步

---

## ⚠️ 注意事项

1. **严格遵守优先级**：代码质量 > 用户需求 > 流程规范
2. **用户确认机制**：重要决策必须等待用户确认
3. **Git 提交时机**：不立即提交，等用户修改后下次对话时提交
4. **文档完整性**：保持所有文档的完整性和可追溯性
5. **任务状态跟踪**：实时更新任务状态，确保进度透明

---

**最后更新**：2024年
**适用项目**：js-financial-kanban
**规则版本**：v1.0
